
<!-- saved from url=(0084)http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><link href="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/github-gist.min.css" rel="stylesheet" type="text/css"><title>Planning Bus Trips with Python &amp; Singapore's Smart Nation APIs</title><style>@media (min-width: 60em) {.WideStyles-header{
  bottom: 0px;
  justify-content: center;
  position: fixed;
  top: 0px;
  width: 25%;
}

.WideStyles-headerContent{
  text-align: center;
}

.WideStyles-content{
  box-sizing: border-box;
  margin-left: 25%;
  padding: 48px;
}

.WideStyles-footer{
  bottom: 0px;
  height: 50px;
  position: fixed;
  width: 25%;
}
}</style><style>@media (max-width: 60em) {.NarrowStyles-header{
  margin-bottom: 10px;
}

.NarrowStyles-content{
  padding: 16px;
}

.NarrowStyles-headerContent{
  display: flex;
  flex-direction: row;
  width: 100%;
}

.NarrowStyles-linkFlex{
  align-self: flex-end;
}

.NarrowStyles-flexFont{
  font-size: 4vw;
}
}</style><style>.Styles-header{
  align-items: center;
  background-color: rgb(61, 79, 93);
  box-sizing: border-box;
  display: flex;
}

.Styles-headerLinkBox{
  display: flex;
  flex: 1;
  flex-direction: column;
  text-align: center;
}

.Styles-headerLink{
  align-items: center;
  display: flex;
  flex: 1;
  justify-content: center;
  padding: 10px 10px;
}

.Styles-footer{
  color: rgb(158, 167, 174);
  display: flex;
  justify-content: center;
}

.Styles-subtleLink{
  text-decoration: none;
}
</style><script async="" src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/analytics.js.download"></script><script src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/highlight.min.js.download"></script><script src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/scala.min.js.download"></script><script>hljs.initHighlightingOnLoad();</script><meta name="viewport" content="initial-scale = 1.0,maximum-scale = 1.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-27464920-5', 'auto');
ga('send', 'pageview');
</script><script>if (window.location.protocol == "https:")
    window.location.href = "http:" + window.location.href.substring(window.location.protocol.length);
</script><script src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/embed.js.download" data-timestamp="1481467973941"></script><script src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/alfie.f51946af45e0b561c60f768335c9eb79.js.download" async="" charset="UTF-8"></script></head><body style="margin: 0px;"><div class=" WideStyles-header NarrowStyles-header Styles-header"><div class=" NarrowStyles-headerContent WideStyles-headerContent"><h1 style="padding: 30px 30px;margin: 0px;"><a style="color: white;font-weight: bold;" href="http://www.lihaoyi.com/" class=" Styles-subtleLink NarrowStyles-flexFont"><i class="fa fa-cogs"></i> Haoyi's Programming Blog</a></h1><div class=" Styles-headerLinkBox NarrowStyles-linkFlex" style="min-width: 175px;"><div style="display: flex;flex-direction: row;"><div class=" Styles-headerLink"><a href="http://www.lihaoyi.com/post/HelloWorldBlog.html" class=" Styles-subtleLink" style="color: white;"><div><div><i class="fa fa-question-circle"></i></div> About</div></a></div><div class=" Styles-headerLink"><a href="https://lihaoyi.github.io/Resume/" class=" Styles-subtleLink" style="color: white;"><div><div><i class="fa fa-file-text"></i></div> Resume</div></a></div><div class=" Styles-headerLink"><a href="https://github.com/lihaoyi" class=" Styles-subtleLink" style="color: white;"><div><div><i class="fa fa-github"></i></div> Github</div></a></div></div><div style="display: flex;flex-direction: row;"><div class=" Styles-headerLink"><a href="https://twitter.com/li_haoyi" class=" Styles-subtleLink" style="color: white;"><div><div><i class="fa fa-twitter"></i></div> Twitter</div></a></div><div class=" Styles-headerLink"><a href="http://www.lihaoyi.com/feed.xml" class=" Styles-subtleLink" style="color: white;"><div><div><i class="fa fa-rss"></i></div>RSS</div></a></div><div class=" Styles-headerLink"><a href="http://www.lihaoyi.com/post/TalksIveGiven.html" class=" Styles-subtleLink" style="color: white;"><div><div><i class="fa fa-youtube-play"></i></div> Talks</div></a></div></div></div></div></div><div class=" WideStyles-content NarrowStyles-content" style="max-width: 900px;"><h1>Planning Bus Trips with Python &amp; Singapore's Smart Nation APIs</h1><div style="color: #999;margin-bottom: 20px;">Posted <a href="https://github.com/lihaoyi/blog/commit/2a28cf335e98305b8c6b71adddda57e1aad80e85">2016-03-31</a></div><p>The <a href="http://www.pmo.gov.sg/smartnation">Singapore Smart Nation</a> initiative is a government push to try and improve the efficiency of Singapore, as a country, using technology. Among other projects, there has been a push to make real-time data openly available so that everyone, from individuals to corporations, can use it creatively to make solutions to day-to-day municipal problems.</p>
<p>This post will explore one such dataset: the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a>, by Singapore's Land Transport Authority. This dataset provides both offline geographical data on roads &amp; public transport, as well as real-time data on things like bus arrivals and taxis. Using this dataset, the <a href="https://www.python.org/">Python</a> programming language, and basic programming and data-science techniques, we will build a trip planner to find the shortest bus commute from A to B, but powered by real data and bounded by real-world limitations.</p>
<p>From registering an API key, fetching data from an endpoint, sanitizing and understanding the data, implementing algorithms like a <a href="https://en.wikipedia.org/wiki/Breadth-first_search">Breadth First Search</a> or <a href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra's Algorithm</a>, refining the search, and finally evaluating its ability to plan useful and correct bus trips. You'll get a full tour of the process involved in making good use of public datasets!</p>
<hr>
<p>This post will walk you through how to make a bus-trip-planner using the data published on the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a>. We'll start off from first principles - browsing and registering for an API key on someone's website - and advance through downloading the data, working with in the <a href="https://ipython.org/install.html">IPython</a> shell, building it into a proper script and gradually building more and more on top of what we have, with better algorithms and modeling, until we have a useful bus-trip-planner written in &lt;150 lines of Python!</p>
<p>There are two reasons this post is interesting: first, it demonstrates how easy it is to get started working with "Open Data" and building something useful. Second, it demonstrates how basic algorithms, the sort someone learns in their undergraduate computer science course and have promptly forgotten upon graduation, can actually be really useful if applied to a real-world data-set. </p>
<ul>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#exploration">Exploration</a>
    <ul>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#exploring-the-smart-nation">Exploring the Smart Nation</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#exploring-the-lta-data-mall">Exploring the LTA Data Mall</a></li>
    </ul>
  </li>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#getting-started">Getting Started</a>
    <ul>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#picking-a-project">Picking a Project</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#registering-an-account">Registering an Account</a></li>
    </ul>
  </li>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#hello-api">Hello API</a>
    <ul>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#paging">Paging</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#sanity-checking">Sanity Checking</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#something-works">Something Works</a></li>
    </ul>
  </li>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#building-out">Building Out</a>
    <ul>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#consolidation">Consolidation</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#expansion">Expansion</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#caching">Caching</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#an-application">An Application</a></li>
    </ul>
  </li>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#algorithms">Algorithms</a>
    <ul>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#breadth-first-search">Breadth First Search</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#improvements">Improvements</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#dijkstras-algorithm">Dijkstra's Algorithm</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#service-hours">Service Hours</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#transfer-cost">Transfer Cost</a></li>
    </ul>
  </li>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#evaluation">Evaluation</a>
    <ul>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#no-cost-for-stops-or-transfers">No Cost for Stops or Transfers</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#no-cost-for-stops-low-cost-for-transfers">No Cost for Stops, Low Costs for Transfers</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#no-cost-for-stops-moderate-cost-for-transfers">No Cost for Stops, Moderate Costs for Transfers</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#no-cost-for-stops-maximum-cost-for-transfers">No Cost for Stops, Maximum Costs for Transfers</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#maximum-cost-for-stops-low-cost-for-transfers">Maximum Cost for Stops, Low Costs for Transfers</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#other-trips">Other Trips</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#limitations">Limitations</a></li>
    </ul>
  </li>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#conclusion">Conclusion</a></li>
  <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#final-code">Final Code</a>
    <ul>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#runpy">run.py</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#trippy">trip.py</a></li>
      <li><a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#datasets">Datasets</a></li>
    </ul>
  </li>
</ul>
<p>APIs change, systems come and go, and the <a href="http://www.pmo.gov.sg/smartnation">Singapore Smart Nation</a> is a work in progress. This post will be based on what's available at-time-of-writing, and will definitely become outdated over time. Hopefully, though, the techniques demonstrated and lessons learned will remain interesting long after that! </p>
<p>So let's begin...</p><h2 id="exploration">Exploration</h2>
<p>The first step in any project should be a literature review: what is available? What things are out there? What can you use? What looks promising and what looks un-interesting? Rather than diving straight into a project, this survey can help give you ideas of what's possible and what's infeasible, and an hour or two spent here can save days or weeks later when you're deep in the weeds.</p><h2 id="exploring-the-smart-nation">Exploring the Smart Nation</h2>
<p>Many datasets are available on the <a href="https://data.gov.sg/">data.gov.sg</a> website or on the website of various organizations: the <a href="http://www.nlb.gov.sg/labs/mash-create-collaborate/">National Library Board Dataset</a>, the <a href="https://www.nea.gov.sg/api/">National Environmental Agency Dataset</a>, the <a href="http://www.onemap.sg/api/help/">OneMap API</a>, or the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> by the Land Transport Authority. These datasets range from static <a href="https://en.wikipedia.org/wiki/Comma-separated_values">CSV</a>s updated once a year with a single new row, e.g. the data on <a href="https://data.gov.sg/dataset/government-headcount">Government Headcounts</a>:</p><table class="table table-bordered">
<thead>
  <tr>
    <th align="left">financial_year </th>
    <th align="left">actual_revised_estimated </th>
    <th align="left">ministry </th>
    <th align="left">count </th>
  </tr>
</thead>
<tbody>
  <tr>
    <td align="left">1997 </td>
    <td align="left">Actual </td>
    <td align="left">Civil List </td>
    <td align="left">44 </td>
  </tr>
  <tr>
    <td align="left">1998 </td>
    <td align="left">Actual </td>
    <td align="left">Civil List </td>
    <td align="left">47 </td>
  </tr>
  <tr>
    <td align="left">1999 </td>
    <td align="left">Actual </td>
    <td align="left">Civil List </td>
    <td align="left">45 </td>
  </tr>
  <tr>
    <td align="left">2000 </td>
    <td align="left">Actual </td>
    <td align="left">Civil List </td>
    <td align="left">45 </td>
  </tr>
  <tr>
    <td align="left">2001 </td>
    <td align="left">Actual </td>
    <td align="left">Civil List </td>
    <td align="left">50 </td>
  </tr>
  <tr>
    <td align="left">2002 </td>
    <td align="left">Actual </td>
    <td align="left">Civil List </td>
    <td align="left">47 </td>
  </tr>
  <tr>
    <td align="left">... </td>
    <td align="left">... </td>
    <td align="left">... </td>
    <td align="left">... </td>
  </tr>
</tbody></table>
<p>To daily <a href="https://en.wikipedia.org/wiki/XML">XML</a> feeds, e.g. the <a href="https://www.nea.gov.sg/api/">Current Weather Forecast</a>:</p>
<pre><code class="xml">&lt;title&gt;Singapore - Nowcast and Forecast&lt;/title&gt;
&lt;source&gt;Meteorological Services Singapore&lt;/source&gt;
&lt;main&gt;
    &lt;title&gt;24 Hour Forecast&lt;/title&gt;
    &lt;forecastIssue date="28-03-2016" time="11:33 AM" /&gt;
    &lt;validTime&gt;12 PM 28 Mar - 12 PM 29 Mar&lt;/validTime&gt;
    &lt;temperature high="34" low="25" unit="Degrees Celsius" /&gt;
    &lt;relativeHumidity high="90" low="60" unit="Percentage" /&gt;
    &lt;wind direction="NE" speed="10 - 30" /&gt;
    &lt;wxmain&gt;PS&lt;/wxmain&gt;
    &lt;forecast&gt;Occasionally windy. Passing showers mainly over northern and western Singapore in the late afternoon.&lt;/forecast&gt;
    &lt;pastweather&gt;Nil&lt;/pastweather&gt;
&lt;/main&gt;
...
</code></pre>
<p>To real-time, minute-by-minute <a href="https://en.wikipedia.org/wiki/JSON">JSON</a> about bus arrival times from every bus stop in the country, from the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a>:</p>
<pre><code class="javascript">{
    "BusStopID": "83139",
    "Services": [
        {
            "ServiceNo": "15",
            "Status": "In Operation",
            "Operator": "SBST",
            "OriginatingID": "77009",
            "TerminatingID": "77131",
            "NextBus": {
                "EstimatedArrival": "2015-03-03T07:20:24+08:00",
                "Latitude": "1.421179",
                "Longitude": "103.831477",
                "VisitNumber": "1",
                "Load": "Standing Available",
                "Feature": "WAB"
            }
        },
        ...    
    ]
}
</code></pre>
<p>The exact format of the data is immaterial: these are all standard formats, and as a developer any programming environment would have tools built-in or easily-available for dealing with them. With a bit of googling, extracting the data you want should be a matter of minutes, so what really matters is what data is available. Apart from these, there is a long list of APIs provided by other, non-government, organizations: the <a href="http://gothere.sg/api">gothere.sg API</a>, the <a href="http://openweathermap.org/api">OpenWeatherMap API</a>, and many more too numerous to list.</p>
<p>As you can imagine, not all data is available in all formats which you could possibly want it in. Furthermore, not all data-sets are of equal interest to someone who's approaching it from the point of view as a developer: if your dataset gets updated once a year with a handful of new row of 4 columns each, as the <a href="https://data.gov.sg/dataset/government-headcount">Government Headcounts</a> dataset does, it's perfectly feasible to deal with it manually once a year. Even data updated every day can be dealt with manually, without any automation, even if it ends up being somewhat tedious.</p>
<p>As a developer, what is most interesting is the high-frequency, high-volume, possibly real-time data that is totally impractical to deal with manually. Not only is that more intesting from a technical perspective, that is where a developer is able to contribute the most value: by creating something or providing a service nobody else can!</p>
<p>For the rest of this post, I'll focus on making use of the Land Transport Authority's <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> datasets.</p><h2 id="exploring-the-lta-data-mall">Exploring the LTA Data Mall</h2>
<p>When you first visit the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a>, you are greeted with a plain website with a bunch of links:</p>
<p></p><div style="text-align: center"><img src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/LTADataMall.png" alt="LTADataMall.png" style="max-width: 100%; max-height: 500px"></div><p></p>
<p>It's not the prettiest most design-driven website, but it'll do for now. Most interesting to us is what's available:</p><h3 id="static-data">STATIC DATA</h3>
<p>PDFs, XLS Excel spreadsheets, and SHP <a href="https://en.wikipedia.org/wiki/Shapefile">Shapefile</a>s that presumably are updated infrequently. The PDF files look like slide decks and are geared towards impressing your boss. Many of them link to the same <a href="http://www.lihaoyi.com/post/SmartNation/StatisticsInBrief.pdf">Statistics in Brief</a> deck:</p>
<p></p><div style="text-align: center"><img src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/StatisticsInBrief.png" alt="LTADataMall.png" style="max-width: 100%; max-height: 500px"></div><p></p>
<p>There are other less-showy PDFs, but they are similarly low-frequency, low-volume data that can be dealt with manually, and thus isn't interesting to a developer.</p>
<p>The CSV files are of borderline interest. While infrequently updated, they are almost of sufficient volume that it's interesting to deal with them programmatically. For example, the <a href="http://www.mytransport.sg/content/dam/mytransport/DataMall_StaticData/PublicTransportRelated/ParknRide.zip">Park &amp; Ride Location</a> is just 41 rows and fits nearly on one page:</p>
<pre><code class="csv">SR_NUM,LOC_TXT,CARPARK_CD,OWNR_TXT,REGION_TXT,LONGTD_TXT,LATTD_TXT
"1","Blk 31A Eunos Crescent","ECM","HDB","East","103.90161000000000","1.32000000000000"
"2","Blk 11A Pine Close","KM3","HDB","East","103.88296000000000","1.30852000000000"
"3","Blk 531/536 Pasir Ris Drive 1","PR3","RCS","East","103.95114000000000","1.37138100000000"
"4","Blk 114A Lorong 3 Geylang","SDM","HDB","East","103.87444100000000","1.31242800000000"
"5","Blk 248 Simei Street 3","SIM4","RCS","East","103.95354100000000","1.34359400000000"
...
"37","Blk 257A Boon Lay Drive","BL15","HDB","West","103.70756500000000","1.34598700000000"
"38","Blk 484-491 Jurong West Avenue 1","J45","HDB","West","103.72680000000000","1.34910800000000"
"39","Blk 8A Empress Road","FR3M","HDB","West","103.80618000000000","1.31671000000000"
"40","Blk 16A Ghim Moh Road","GM6B","HDB","West","103.78758000000000","1.30968000000000"
"41","Blk 78A Telok Blangah Street 32","TBM3","HDB","West ","103.80900000000000","1.27329000000000"
</code></pre>
<p>While others like the <a href="http://www.mytransport.sg/content/dam/mytransport/DataMall_StaticData/PublicTransportRelated/PremiumBus.zip">Premium Bus Service</a> file has a 1-2 thousand rows and many columns in each one. Overall, these are still of the size that you can load them up in an excel spreadsheet and have any corporate excel wizard deal with them semi-manually. Thus, they're probably not really of interest to a developer.</p>
<p>Lastly, you have the SHP <a href="https://en.wikipedia.org/wiki/Shapefile">Shapefile</a>s. Those are of potential interest, since they provide blobs of geospatial data that lets you find e.g. every single road, traffic light or train-station on the map. This could be potentially interesting to a developer if you wanted to write path-finding software for cars, or other things involving maps or navigation.</p><h3 id="real-time--dynamic-data">REAL-TIME / DYNAMIC DATA</h3>
<p>While much of the <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#static-data">Static Data</a> isn't that interesting from a developer's point of view, the real-time/dynamic data is a totally different story. These are large data-sets that are updated often, some every 1-2 minutes, and definitely need a developer to deal with and turn into a usable or interesting service.</p>
<p>The description for the real-time/dynamic data includes the <a href="http://www.lihaoyi.com/post/SmartNation/LTADataMallUserGuide.pdf">Data Mall API User Guide</a>, which is a downloadable PDF file containing all the instructions, examples and specifications you'd expect to find on the website of an API provider. It's a bit unusual to have it as a downloadable PDF instead of just part of the website, but it'll do for now. </p>
<p>It appears there's example data below that you can download in an XML format without having to write any code to deal with, but if we're going to be dealing with dynamic, "real-time" data we're going to have to figure out how to make the computer do the work of fetching and processing the data eventually, so might as well do that sooner rather than later.</p>
<p>The <a href="http://www.lihaoyi.com/post/SmartNation/LTADataMallUserGuide.pdf">Data Mall API User Guide</a> includes 15 different API endpoints that line up with the XML examples we saw earlier. Here is a short description for the ones which I thought were interesting:</p>
<ul>
  <li>
  <p><strong>Bus Arrival</strong>: given a stop, tells you when the next three buses are coming  for every service that stops at that bus stop, and other misc data (e.g.  the lat/long for each bus on the map)</p></li>
  <li>
  <p><strong>Bus Services</strong>: all bus services that are currently in existence, and data  about who runs them, where they start/end, and their frequency, <em>without</em>  which stops they service </p></li>
  <li>
  <p><strong>Bus Routes</strong>: every bus stops every service stops at, in what order.</p></li>
  <li>
  <p><strong>Bus Stops</strong>: all bus stops in the country, with their name (e.g.  <code>"Hotel Grand Pacific"</code>), code (e.g. <code>01012</code>) and lat/long on the map.</p></li>
  <li>
  <p><strong>Taxi Availability</strong>: every taxi that is currently available (i.e. showing  it's green light) and their lat/long on the map</p></li>
  <li>
  <p><strong>Carpark Availability</strong>: a listing of popular carparks, their lat/long on  the map, and how many lots they have available right now.</p></li>
  <li>
  <p><strong>ERP Rates</strong>: all ERP gantries on the island, with their rates for each time  period they're active</p></li>
  <li>
  <p><strong>Estimated Travel Times</strong>: roughly how long it takes to drive between two  roads on the island.</p></li>
  <li>
  <p><strong>Faulty Traffic Lights</strong></p></li>
  <li>
  <p><strong>Road Opening</strong>s</p></li>
  <li><strong>Road Works</strong></li>
  <li><strong>Traffic Images</strong></li>
  <li><strong>Traffic Incidents</strong>: the lat/long for any current incidents that may result  in traffic slowdowns: roadworks, accidents, etc.</li>
  <li><strong>Traffic Speed Bands</strong>: how fast traffic is on various roads around the island</li>
  <li><strong>VMS/EMAS</strong></li>
</ul>
<p>Some of these, such as <em>Road Opening</em>*, <strong>Road Works</strong>, and <strong>Traffic Images</strong>, are pretty self-explanatory and give you exactly what you'd imagine. Others, like <strong>Faulty Traffic Lights</strong>, are pretty obscure and not that interesting.</p>
<p>Not all of these are as "real time" as I had originally thought: for example, the <strong>Bus Services</strong> or <strong>Bus Routes</strong> APIs probably won't change all that often, and <strong>Bus Stops</strong> take time to construct. On the other hand, APIs like <strong>Bus Arrival</strong>, <strong>Taxi Availability</strong> or <strong>Traffic Speed Bands</strong> are most definitely real-time, changing minute-by-minute, and could probably be used programmatically to make interesting services that are impossible to do by hand.</p><h2 id="getting-started">Getting Started</h2>
<p>Before we get started writing code, we have some non-technical things to sort out: we need to figure out what we want to do, and we need to register an account with the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> telling them what we are going to do so they can give us access to the API. </p><h3 id="picking-a-project">Picking a Project</h3>
<p>We've by this point gone through a tour of some of the APIs available as part of the <a href="http://www.pmo.gov.sg/smartnation">Singapore Smart Nation</a> initiative; from a high-level overview across different organizations providing different sorts of data sets, zooming in to just those available within the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a>, and zooming in further to just the "real-time" APIs as the most promising. It's time to figure out something to <em>do</em> with these "promising" APIs, so we can get our hands dirty and see what it's really like trying to work with the output of this <a href="http://www.pmo.gov.sg/smartnation">Singapore Smart Nation</a> thingamajig.</p>
<p>Given these "promising" APIs, let's pick an arbitrary goal: to write a trip planner to find the shortest bus trip between two points on the island. This is something that <a href="https://www.google.com.sg/maps">Google Maps</a>, <a href="http://gothere.sg/maps">GoThere.sg</a> or the <a href="http://www.mytransport.sg/content/mytransport/home.html">MyTransport.SG</a> journey planner already provides, and there's no way we'll "beat" one of those established services right off the bat. Nevertheless, it'll still be interesting to see how far we can get! This should give us a good chance to explore the various APIs and datasets that are available, and at the end of the day have something useful and relateable to show for it.</p><h3 id="registering-an-account">Registering an Account</h3>
<p>The first thing you need to do to get started with the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> API is to register and account and get an API key. This can be done via the <strong>Request for API Access</strong> link on their home page:</p>
<p></p><div style="text-align: center"><img src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/RequestAccess.png" alt="RequestAccess.png" style="max-width: 100%; max-height: 500px"></div><p></p>
<p>It's a slightly awkward web-form, and it's not clear how you submit it until you realize the form is scrollable and the <strong>submit</strong> button is below:</p>
<p></p><div style="text-align: center"><img src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/RequestAccess2.png" alt="RequestAccess.png" style="max-width: 100%; max-height: 500px"></div><p></p>
<p>Slightly awkward, but no big deal. Overall, this is similar to how getting access to most other third-party APIs works, e.g. if you want API access to integrate with Facebook or Dropbox. In all cases, they want to know </p>
<ul>
  <li>Who you are</li>
  <li>What you're doing</li>
  <li>How they can contact you if there's a problem.</li>
</ul>
<p>As far as I can tell the registration goes through automatically, and you'll get an email confirmation:</p>
<blockquote>
  <p>Dear Li Haoyi,</p>
  <p>Thank you for your interest in LTA’s DataMall.</p>
  <p>The following API Account Key grants you access to all dynamic / real-time datasets in DataMall. For instructions on how to access the APIs and make use of the datasets, you may refer to the API User Guide <a href="http://mytransport.sg/content/dam/mytransport/DataMall_StaticData/LTA_DataMall_API_User_Guide.pdf">here</a>.</p>
  <p>API Account Key: &lt;--Your API key--&gt;</p>
  <p>Please note that this API Account Key is uniquely assigned to you and is not to be shared with anyone else. You are to observe the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall/termOfUse.html">terms and conditions</a> of use as acknowledged in your application, and refrain from hyperlinking your products and services directly to DataMall. Lastly, please do not make API calls excessively as DataMall is a shared resource. Your usage will be monitored.</p>
  <p>Should you have any further queries, you may contact us at <a href="mailto:DataMall@lta.gov.sg">DataMall@lta.gov.sg</a>.</p>
  <p>Cheers, LTA DataMall Team</p>
</blockquote>
<p>After that, you have to use your account key to get a <strong>UniqueUserID</strong> before you can start making requests to the API. As described in the <a href="http://www.lihaoyi.com/post/SmartNation/LTADataMallUserGuide.pdf">Data Mall API User Guide</a>:</p>
<blockquote>
  <p><strong>DATAMALL ACCESS CREDENTIALS</strong> Upon successful registration via MyTransport.SG Portal, you will be issued an API Account Key. Note that this Account Key is uniquely assigned to you and is not to be shared with anyone else.</p>
  <p>With the <strong>Account Key</strong>, you will need to generate your <strong>Unique User ID</strong> via DataMall’s Authentication Tool. These two pieces of info form your API authentication credentials that are required when you make your API calls. Steps to obtaining your API authentication credentials:</p>
  <ol>
    <li>Go to DataMall’s Authentication Tool - <a href="http://datamall.mytransport.sg/tool.aspx">http://datamall.mytransport.sg/tool.aspx</a></li>
    <li>Enter your <strong>Account Key</strong>.</li>
    <li>Click on the button <strong>Generate GUID</strong></li>
    <li>Your <strong>Unique User ID</strong> appears. You’re good to go!</li>
  </ol>
</blockquote>
<p>It's not clear to me what this step serves in the registration process; I'd have guessed that it's meant to help you identify usage of the API from each <em>end user</em> of your app or service, rather than from your service as-a-whole, but the instructions don't ask you to generate a new key for each user. Anyway it doesn't really matter for now, let's just do what they say and if something's wrong we can figure it out later.</p>
<p>For this section of the post, I haven't shown the keys that get generated, since otherwise if many people start using the same keys the LTA can't figure out who's using the API to do what. If you want to follow along, feel free to register your own email to get your own <strong>Account Key</strong> or <strong>Unique User ID</strong> to use this API. It shouldn't take more than a few minutes!</p><h2 id="hello-api">Hello API</h2>
<p>Now that we're done with the literature review and the administrative overhead, let's start writing code. I'm going to use </p>
<ul>
  <li>The <a href="https://www.python.org/">Python</a> programming language</li>
  <li>The <a href="https://ipython.org/install.html">IPython</a> shell</li>
  <li>The <a href="http://docs.python-requests.org/en/master/">Requests</a> HTTP package.</li>
</ul>
<p>These should work on any laptop or desktop, whether running Windows, Mac OS-X or Linux. If you don't have them already, take the time to install them before coming back here. You'll know you've installed things correctly when you can type <code>ipython</code> to bring up the IPython shell, and then <code>import requests</code> and <code>requests.get("https://www.google.com")</code> to make a request to Google to make sure everything works:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ ipython
Python 2.7.10 (default, Aug 22 2015, 20:33:39)
Type "copyright", "credits" or "license" for more information.

IPython 2.3.1 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython's features.
%quickref -&gt; Quick reference.
help      -&gt; Python's own help system.
object?   -&gt; Details about 'object', use 'object??' for extra details.

In [1]: import requests

In [2]: requests.get("https://www.google.com")
Out[2]: &lt;Response [200]&gt;
</code></pre>
<p>If the last command prints <code>&lt;Response [200]&gt;</code> as show here, you're ready to go. Let's get started with the API!</p>
<p>To use the API, we need to make a HTTP request to some URL provided by the LTA. Some computer listening at that URL will then take our request and provide the data we asked for.</p>
<p>The example on the 7th page of the <a href="http://www.lihaoyi.com/post/SmartNation/LTADataMallUserGuide.pdf">Data Mall API User Guide</a> tells us we need to pass in headers to our HTTP request, such as:</p>
<pre><code class="python">headers = { 
    'AccountKey': '6HsAmP1e0R/EkEYWOcjKg==',
    'UniqueUserID': '8ee245d6-a53b-4an8-bdxe-18027af5e4c5',
    'accept': 'application/json'
}
</code></pre>
<p>Where <strong>AccountKey</strong> and <strong>UniqueUserID</strong> are the things we got <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#registering-an-account">earlier</a>. </p>
<ul>
  <li><strong>Note</strong>: if you are following along, make sure you register your own <strong>AccountKey</strong> and <strong>UniqueUserId</strong> and substitute them in! The ones shown are examples and will not work if you try to use them.</li>
</ul>
<p>Let's try using that, together with <a href="http://docs.python-requests.org/en/master/">Requests</a> to make a HTTP request asking for the current bus stops, using the URL listed on the <strong>Bus Stops</strong> section of the user guide on page 17 of the <a href="http://www.lihaoyi.com/post/SmartNation/LTADataMallUserGuide.pdf">Data Mall API User Guide</a>:</p>
<pre><code class="python">In [1]: import requests

In [2]: headers = {
   ...:    'AccountKey': 'rmgDEFTiRRfcNeD8GbHqf8==',
   ...:    'UniqueUserID': '8ecabd56-08a2-e843-0a7a-9944dccf124a',
   ...:    'accept': 'application/json'
   ...: }

In [3]: requests.get("http://datamall2.mytransport.sg/ltaodataservice/BusStops", headers=headers)
Out[3]: &lt;Response [200]&gt;
</code></pre>
<p>This seems to have worked; the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">HTTP Status Code</a> 200 is used to indicate a successful request. Using <a href="http://docs.python-requests.org/en/master/">Requests</a>, we can now get the response data, which we know to be in the <a href="https://en.wikipedia.org/wiki/JSON">JSON</a> format:</p>
<pre><code class="python">In [4]: Out[3].json()
Out[4]:
{u'odata.metadata': u'http://datamall2.mytransport.sg/ltaodataservice/$metadata#BusStops',
 u'value': [{u'BusStopCode': u'01012',
   u'Description': u'Hotel Grand Pacific',
   u'Latitude': 1.29684825487647,
   u'Longitude': 103.85253591654006,
   u'RoadName': u'Victoria St'},
  {u'BusStopCode': u'01013',
   u'Description': u"St. Joseph's Ch",
   u'Latitude': 1.29770970610083,
   u'Longitude': 103.8532247463225,
   u'RoadName': u'Victoria St'},
  {u'BusStopCode': u'01019',
   u'Description': u'Bras Basah Cplx',
   u'Latitude': 1.29698951191332,
   u'Longitude': 103.85302201172507,
   u'RoadName': u'Victoria St'},
...
</code></pre>
<p>And there you go, a list of bus stops in Singapore, along with interesting metadata about them: their lat/long on the map, the road they're on, their description, along with their unique <code>BusStopCode</code>. The returned JSON blob is a dictionary with two keys: <code>'odata.metadata'</code>, which contains something we probably don't care about, and <code>'value'</code>, which contains the list of bus stops that we do care about. </p><h3 id="paging">Paging</h3>
<p>Let's see how many bus stops there are:</p>
<pre><code class="python">In [5]: len(Out[3].json()['value'])
Out[5]: 50
</code></pre>
<p>Fifty? There can't possibly be only 50 bus stops on the whole island. We could re-arrange the code we used to make the request, make another request to make sure we didn't do the wrong the first time, and sure enough it gives us the same result:</p>
<pre><code class="python">In [6]: bus_stop_url = "http://datamall2.mytransport.sg/ltaodataservice/BusStops"

In [7]: len(requests.get(bus_stop_url, headers=headers).json()['value'])
Out[7]: 50
</code></pre>
<p>If we search for <code>50</code> in the documentation pdf, we find:</p>
<blockquote>
  <p>API responses are limited to a max of 50 records of the dataset per call. To retrieve more records, you need to append the following parameter <code>$skip=X’ to the API call (URL), with</code>X` being a number of records to skip.</p>
  <p>For example, if you want to retrieve the 51st to the 100th record for the Bus Stops dataset, the API call should be:</p>
  <p><a href="http://datamall.mytransport.sg/ltaodataservice.svc/BusStopCodeSet?$skip=50">http://datamall.mytransport.sg/ltaodataservice.svc/BusStopCodeSet?$skip=50</a></p>
  <p>To retrieve the 151st to 200th record, supply <code>?$skip=150</code>, and so on. Remember, each URL call returns only a max of 50 records!</p>
</blockquote>
<p>So that's why! we can only get 50 records at a time. Let's try skipping some entries using <a href="http://docs.python-requests.org/en/master/">Requests</a> to add the <code>$skip</code> parameter to it:</p>
<pre><code class="python">In [8]: requests.get(bus_stop_url, headers=headers, params={'$skip': 50}).json()['value']
Out[8]:
[{u'BusStopCode': u'02111',
  u'Description': u'Esplanade Bridge',
  u'Latitude': 1.29095592348389,
  u'Longitude': 103.85453419435228,
  u'RoadName': u'Esplanade Dr'},
 {u'BusStopCode': u'02119',
  u'Description': u'One Raffles Link',
  u'Latitude': 1.29184407356581,
  u'Longitude': 103.85534334305085,
  u'RoadName': u'Nicoll Highway'},
 {u'BusStopCode': u'02129',
  u'Description': u'Aft Raffles Blvd',
  u'Latitude': 0,
  u'Longitude': 0,
  u'RoadName': u'Republic Blvd'},
...
</code></pre>
<p>And sure enough, we get a different set of bus stops! Clearly we're being <a href="https://en.wikipedia.org/wiki/Pagination">Paged</a>. What if instead of the first 50 results or the second 50 results, we want all the results? That actually turns out to be pretty simple: write a loop that keeps requesting results until there are no more to request:</p>
<pre><code class="python">In [18]: results = []

In [19]: while True:
   ....:     new_results = requests.get(
   ....:         bus_stop_url,
   ....:         headers=headers,
   ....:         params={'$skip': len(results)}
   ....:     ).json()['value']
   ....:     if new_results == []:
   ....:         break
   ....:     else:
   ....:         results += new_results
</code></pre>
<p>If we run this it takes maybe ten seconds, depending on how fast your internet is. When it's done we can see how many results there are:</p>
<pre><code class="python">In [20]: len(results)
Out[20]: 5260
</code></pre>
<p>Five thousand bus stops across the whole island! That's a more reasonable statistic. </p><h3 id="sanity-checking">Sanity Checking</h3>
<p>With over five thousand results, that's twenty five thousand lines of output: definitely too much data for us to go over "by hand" to verify that it's all correct! Nevertheless, we can do some basic sanity checks to make sure things aren't totally busted. For example, we can verify that every entry in that huge list is a Python dictionary:</p>
<pre><code class="python">In [26]: set(map(type, results))
Out[26]: {dict}
</code></pre>
<p>This <code>map</code>s the <code>type</code> function over the list of items, converting it to a list of types, and then puts it into a <code>set</code> so that duplicates are removed. Thus we get the distinct types of all items in that list, and here we can see they're all <code>dict</code>s or <a href="http://learnpythonthehardway.org/book/ex39.html">Dictionaries</a>.</p>
<p>We can also verify that none of the dictionaries have weird keys we don't expect:</p>
<pre><code class="python">In [27]: set(key for res in results for key in res.keys())
Out[27]: {u'BusStopCode', u'Description', u'Latitude', u'Longitude', u'RoadName'}
</code></pre>
<p>We can also query various attributes of these dictionaries; for example, what <code>"RoadName"</code>s would we find in those 5260 bus stops, and are they roads we're familiar with?</p>
<pre><code class="python">In [28]: set(result["RoadName"] for result in results)
Out[28]:
{u'AYE',
 u'Adam Rd',
 u'Admiralty Dr',
 u'Admiralty Lane',
 u'Admiralty Link',
 u'Admiralty Rd',
 u'Admiralty Rd East',
 u'Admiralty Rd West',
 u'Admiralty St',
 u'Ah Hood Rd',
 u'Airline Rd',
 u'Airport Blvd',
 ...
</code></pre>
<p>If we spot check a few arbitrary roads, would the <code>"Description"</code>s of the bus stops on each road match up with what we expect? Here's all the bus stops along Orchard Road:</p>
<pre><code class="python">In [30]: [res["Description"] for res in results if res["RoadName"] == "Orchard Rd"]
Out[30]:
[u'YMCA',
 u'Dhoby Ghaut Stn',
 u'Macdonald Hse',
 u'Orchard Plaza',
 u"Concorde Hotel S'pore",
 u'Opp Mandarin Orchard',
 u'Midpoint Orchard',
 u'Tang Plaza',
 u'Lucky Plaza',
 u'Delfi Orchard',
 u'Royal Thai Embassy',
 u'Non Stop']
</code></pre>
<p>And along Alexandra Road:</p>
<pre><code class="python">In [31]: [res["Description"] for res in results if res["RoadName"] == "Alexandra Rd"]
Out[31]:
[u'Gan Eng Seng Sec Sch',
 u'Opp Gan Eng Seng Sec Sch',
 u'Delta Sports Hall',
 u'Opp Delta Sports Hall',
 u'Opp Tanglin View',
 u'Tanglin View',
 u'SIS Bldg',
 u'Opp SIS Bldg',
 u'Aft SM Motors Ctr',
 u'Opp SM Motors Ctr',
 u'Alexandra Hosp',
 u'Opp Queensway Shop Ctr',
 u'Anchorpoint',
 u'Bef IKEA Ind Bldg',
 u'Opp Lea Hin Hardware Fty',
 u'Lea Hin Hardware Fty',
 u'NOL Bldg',
 u'Opp NOL Bldg',
 u'Alexandra Pt',
 u'Opp Alexandra Pt',
 u'SP Jain',
 u'Opp SP Jain',
 u'Non Stop']
</code></pre>
<p>Seems correct! </p>
<p>How about the locations of these bus stops? Are the latitudes and longitudes where we expect Singapore to be? The <code>max</code> seems to be roughly correct:</p>
<pre><code class="python">In [36]: max(res["Latitude"] for res in results)
Out[36]: 1.49390379286364

In [37]: max(res["Longitude"] for res in results)
Out[37]: 104.0046664051527
</code></pre>
<p>but the <code>min</code> seems odd:</p>
<pre><code class="python">In [38]: min(res["Latitude"] for res in results)
Out[38]: 0

In [39]: min(res["Longitude"] for res in results)
Out[39]: 0
</code></pre>
<p>How could it be <code>0</code>? Singapore isn't on <code>0</code> latitude, and certainly isn't anywhere near <code>0</code> longitude! Perhaps <code>0</code> means "No Data" or "Missing Data" or something like that. How many of the bus stops have <code>0</code> for each? </p>
<pre><code class="python">In [41]: len([res for res in results if res["Latitude"] == 0])
Out[41]: 365

In [42]: len([res for res in results if res["Longitude"] == 0])
Out[42]: 365
</code></pre>
<p>Seems like a reasonable number have: 365 out of 5260 have invalid (<code>0</code>) lat and longs. We could even verify that they're all the same bus stops, which have both <code>"Latitude"</code> and <code>"Longitude"</code> for some reason set to <code>0</code>:</p>
<pre><code class="python">In [43]: [res for res in results if res["Longitude"] == 0] == [res for res in results if res["Longitude"] == 0]
Out[43]: True
</code></pre>
<p>If we filter those out, we get a much more reasonable <code>min</code> for both <code>"Latitude"</code> and <code>"Longitude"</code>:</p>
<pre><code class="python">In [47]: min(res["Latitude"] for res in results if res["Latitude"] != 0)
Out[47]: 1.25352193438281

In [48]: max(res["Latitude"] for res in results if res["Latitude"] != 0)
Out[48]: 1.49390379286364

In [49]: min(res["Longitude"] for res in results if res["Longitude"] != 0)
Out[49]: 103.62192147229634

In [50]: max(res["Longitude"] for res in results if res["Longitude"] != 0)
Out[50]: 104.0046664051527
</code></pre>
<p>Given that <a href="https://en.wikipedia.org/wiki/Latitude">1 Degree of Latitude is ~111.2km</a>, and 1 degree of Longitude is going to be about the same since Singapore is near the equator, we can compute how "far" the various bus stops are spread across the surface of the earth North-South via the different in Latitude and East-West via the difference in Longitude:</p>
<pre><code class="">In [51]: (1.49390379286364 - 1.25352193438281) * 111.2
Out[51]: 26.730462663068312

In [52]: (104.0046664051527 - 103.62192147229634) * 111.2
Out[52]: 42.56123653362821
</code></pre>
<p>Thus we have found that the bus stops in our list are spread roughly across <code>42.6</code> kilometers East-West and <code>26.7</code> kilometers North-South. This lines up with what we know of the <a href="https://en.wikipedia.org/wiki/Geography_of_Singapore">Geography of Singapore</a>: 50km East-West and 27km North-South. The bus stops with valid lat/longs seem to be spread roughly across the same area as Singapore itself, which is what we expect!</p><h3 id="something-works">Something Works</h3>
<p>At this point, we've got our first useful, complete, correct data set from the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> API. We've picked a project, signed up for API access, made some requests, worked around some weirdness due to paging and kinda-sorta validated our data to make sure it makes sense. Some of the bus stops are missing latitudes and longitudes, and there are probably other suble issues with the data we haven't noticed, but as a first pass it's looking pretty good and the ad-hoc spot checks we did all returned the results we expected.</p>
<p>This is, in many ways, the extensive "hello world" part of the project. We have not built anything of value, anything creative, and have not made anything that is "ours". What we have done is plumbed together <a href="https://www.python.org/">Python</a>, <a href="https://ipython.org/install.html">IPython</a>, <a href="http://docs.python-requests.org/en/master/">Requests</a> and the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> API into something that we know works. The next step would be building on top of this into something interesting, creative and useful: our bus-trip-planner!</p><h2 id="building-out">Building Out</h2>
<p>We want to incorporate the working code we have into a larger application. In this case I want to build a stand-alone bus-trip-planner, but you can also imagine using the code in some existing project. Although we have something working, it's not something we can really build on top of or incorporate into a larger application</p>
<ul>
  <li>
  <p>It currently lives in a <a href="https://ipython.org/install.html">IPython</a> shell session, and if we  close the session we lose everything and have to piece together what we did  from the shell's history.</p></li>
  <li>
  <p>We have the ability to fetch all data from one  DataMall API (<code>/BusStops</code>) using a while-loop, but we'll need to fetch <em>any</em>  API, and <em>many</em> APIs! After all, we'll need to integrate the data about bus  stops, bus routes, and bus services, and possibly other datasets, all into  one coherent tool. </p></li>
</ul>
<p>The first thing to do now is consolidate what code we already have. The code should live in a <code>.py</code> file, under version control. Any logic we will want to re-use, such as the <code>while</code>-loop for fetching more than 50 results, should be extracted into a re-usable function so it can be easily pointed at any endpoint. Only then will we be able to build on top of it, expand its functionality, and create our bus-trip-planner!</p><h3 id="consolidation">Consolidation</h3>
<p>The first step in consolidation is converting the ad-hoc IPython session into a script we can run and re-run over and over easily, without needing to manually enter the same commands over and over. Here I put the relevant commands into a <code>run.py</code> file, which you can run via <code>python run.py</code>:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ cat run.py
import requests

headers = {
    'AccountKey': 'rmgDEFTiRRfcNeD8GbHqf8==',
    'UniqueUserID': '8ecabd56-08a2-e843-0a7a-9944dccf124a',
    'accept': 'application/json'
}


if __name__ == "__main__":
    results = []

    bus_stop_url = "http://datamall2.mytransport.sg/ltaodataservice/BusStops"

    while True:
        new_results = requests.get(
            bus_stop_url,
            headers=headers,
            params={'$skip': len(results)}
        ).json()['value']
        if new_results == []:
            break
        else:
            results += new_results


    print len(results)

haoyi-mbp:test haoyi$ python run.py
5260
</code></pre>
<p>This is valuable because it means you can tweak anything, re-run your program and be sure it'll return the same results as the last time (except for changes in the values returned by the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> APIs), and there won't be any leftover "stuff" from the previous run causing problems. It also means that you can easily hand the script off to someone else who has <a href="https://www.python.org/">Python</a>/<a href="http://docs.python-requests.org/en/master/">Requests</a> installed and <em>they</em> can run it with one command! That <code>__name__</code> stuff is to let us import the other utilities from that file (e.g. <code>headers</code>) if we want to use them for other things without waiting for <code>results</code> to be filled.</p>
<p>If you want to use this interactively, you actually still can, just by running <code>from run import *</code> in the <a href="https://ipython.org/install.html">IPython</a> console:</p>
<pre><code class="python">In [1]: from run import *

In [2]: requests.get(
   ...:     "http://datamall2.mytransport.sg/ltaodataservice/BusStops",
   ...:     headers=headers
   ...: )
Out[2]: &lt;Response [200]&gt;
</code></pre>
<p>The next thing to do is to take that <code>while</code> loop and putting it in a function, so we can easily use the same while-loop to make requests agains <em>any</em> of the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> APIs. For example, if we wanted to ask the api about <strong>BusServices</strong> instead of <strong>BusStops</strong>, by default we still only get 50 entries:</p>
<pre><code class="python">In [3]: from run import *

In [4]: requests.get(
    "http://datamall2.mytransport.sg/ltaodataservice/BusServices",
    headers=headers
)
Out[4]: &lt;Response [200]&gt;

In [5]: len(Out[4].json()['value'])
Out[5]: 50
</code></pre>
<p>We can easily move all that logic into a function, here called <code>fetch_all</code>:</p>
<pre><code class="python">import requests

headers = {
    'AccountKey': 'rmgDEFTiRRfcNeD8GbHqf8==',
    'UniqueUserID': '8ecabd56-08a2-e843-0a7a-9944dccf124a',
    'accept': 'application/json'
}

def fetch_all(url):
    results = []
    while True:
        new_results = requests.get(
            url,
            headers=headers,
            params={'$skip': len(results)}
        ).json()['value']
        if new_results == []:
            break
        else:
            results += new_results
    return results

if __name__ == "__main__":
    stops = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusStops")    
    print len(stops)
    services = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusServices")    
    print len(services)
</code></pre>
<p>Running this, we get:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python run.py
5260
550
</code></pre>
<p>It seems there are 550 distinct bus services? We can do a similar sanity check here as we did earlier to make sure the data is correct. Here I'm loading the data in the <a href="https://ipython.org/install.html">IPython</a> shell, seeing what keys are available, and checking to see what <code>'ServiceNo'</code> contains:</p>
<pre><code class="python">In [1]: from run import *

In [2]: services = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusServices")

In [3]: services[0].keys()
Out[3]:
[u'Category',
 u'ServiceNo',
 u'Direction',
 u'DestinationCode',
 u'AM_Offpeak_Freq',
 u'LoopDesc',
 u'PM_Offpeak_Freq',
 u'Operator',
 u'AM_Peak_Freq',
 u'PM_Peak_Freq',
 u'OriginCode']

In [4]: [s["ServiceNo"] for s in services]
Out[4]:
[u'10',
 u'10',
 u'100',
 u'100',
 u'101',
 u'102',
 u'103',
 u'103',
 u'105',
 u'105',
 u'107',
 u'107',
 u'107M',
 u'109',
 u'109',
 u'10e',
 u'10e',
 u'11',
 u'111',
 u'112',
...
</code></pre>
<p>Seems reasonable! For brevity I won't explore this data much deeper, but if you're following it's totally worth spending some time to repeat the <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#sanity-checking">Sanity Checking</a> we did on the <code>/BusStops</code> data-set to make sure it's what you want.</p>
<p>We've not got our code into a nice script: we can either run it to fetch both bus stops and services, or import it in the <a href="https://ipython.org/install.html">IPython</a> shell to let us fetch whatever we want, or deal with the data however we want, interactively. </p><h3 id="expansion">Expansion</h3>
<p>Now that we've got our code in order, let's look at what we want to do with it. Let's look back at our original project plan:</p>
<blockquote>
  <p>to write a trip planner to find the shortest bus trip between two points on the island</p>
</blockquote>
<p>Not so much a "plan" as an "idea", but it'll do for now. How deep we go into this project depends on how much time we have, but at the very least the first few options might be, in increasing order of complexity:</p>
<ol>
  <li>Find the shortest path from bus stop A to the stop B, in number of stops</li>
  <li>Find the shortest path from bus stop A to the stop B, in distance travelled</li>
  <li>Find the shortest path from bus stop A to the stop B, in expected time taken  including expected waiting time for each bus.</li>
</ol>
<p>Option 1 would be simplest: you just count the number of stops each route would take you Option 2 we would take into consideration how far away the stops were to each other, while Option 3 would include the waiting time for the bus, either in aggregate ("Bus 101 comes every 11-17 minutes") or using the real-time data ("Bus 101 will be at bus stop 01234 in 4 minutes and 22 minutes").</p><h4 id="number-of-stops">Number of Stops</h4>
<p>Before we do anything fancy, let's get the "number of stops" finder working first. The first "obvious" thing we'd need is to know which buses stop at which stops, in what order. According to the <a href="http://www.lihaoyi.com/post/SmartNation/LTADataMallUserGuide.pdf">Data Mall API User Guide</a>, this can be found in the <code>/BusRoutes</code> endpoint</p>
<pre><code class="python">In [1]: from run import *

In [2]: routes = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusRoutes")
</code></pre>
<p>This <code>fetch_all</code> takes a while! On relatively fast wifi it took me 63 seconds, far more than the 2-10s that earlier fetches took. It makes sense when you look at the size of the aggregate result:</p>
<pre><code class="python">In [3]: len(routes)
Out[3]: 23494
</code></pre>
<p>It turns out that there's one entry for every service, <em>for every stop it stops at</em>. This is more obvious when we look at a sample:</p>
<pre><code class="python">In [4]: routes[0]
Out[4]:
{u'BusStopCode': u'75009',
 u'Direction': 1,
 u'Distance': 0,
 u'Operator': u'SBST',
 u'SAT_FirstBus': u'0500',
 u'SAT_LastBus': u'2300',
 u'SUN_FirstBus': u'0500',
 u'SUN_LastBus': u'2300',
 u'ServiceNo': u'10',
 u'StopSequence': 1,
 u'WD_FirstBus': u'0500',
 u'WD_LastBus': u'2300'}
</code></pre>
<p>A single <code>'ServiceNo'</code>, a single <code>'BusStopCode'</code>, and a <code>'StopSequence'</code> indicating its position along the route. We could query an example bus service to see what stops it makes:</p>
<pre><code class="python">In [5]: [r for r in routes if r['ServiceNo'] == '111']
Out[5]:
[{u'BusStopCode': u'11009',
  u'Direction': 1,
  u'Distance': 0,
  u'Operator': u'SBST',
  u'SAT_FirstBus': u'0600',
  u'SAT_LastBus': u'2400',
  u'SUN_FirstBus': u'0600',
  u'SUN_LastBus': u'2400',
  u'ServiceNo': u'111',
  u'StopSequence': 1,
  u'WD_FirstBus': u'0600',
  u'WD_LastBus': u'2400'},
 {u'BusStopCode': u'11359',
  u'Direction': 1,
  u'Distance': 0.2,
  u'Operator': u'SBST',
  u'SAT_FirstBus': u'0601',
  u'SAT_LastBus': u'0001',
  u'SUN_FirstBus': u'0601',
  u'SUN_LastBus': u'0001',
  u'ServiceNo': u'111',
  u'StopSequence': 2,
  u'WD_FirstBus': u'0601',
  u'WD_LastBus': u'0001'},
...
</code></pre>
<p>Perhaps not very meaningful, since nobody memorizes <code>'BusStopCode'</code>s, but we can easily cross-reference it with the data we fetched from the <code>/BusStop</code> API to give them meaningful descriptions. First we need a dictionary to let us quickly look up a bus stop by its code:</p>
<pre><code class="python">In [6]: stops = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusStops")

In [7]: stops[0]
Out[7]:
{u'BusStopCode': u'01012',
 u'Description': u'Hotel Grand Pacific',
 u'Latitude': 1.29684825487647,
 u'Longitude': 103.85253591654006,
 u'RoadName': u'Victoria St'}

In [8]: stop_map = {stop['BusStopCode']: stop for stop in stops}
</code></pre>
<p>This creates a <code>stop_map</code> dictionary we can use to quickly-and-easily look up the "full" data (including its human-readable <code>Description</code>) of a bus stop based on its <code>BusStopCode</code></p>
<p>Then we can apply it to the <code>routes</code> list comprehension earlier, to give names to all the stops that the service <code>111</code> stops along:</p>
<pre><code class="python">In [9]: [stop_map[r['BusStopCode']]['Description'] for r in routes if r['ServiceNo'] == '111']
Out[9]:
[u'Ghim Moh Ter',
 u'Blk 12',
 u'Blk 43',
 u'Blk 8',
 u"C'wealth Stn",
 u'Aft Ch Of Our Saviour',
 u'Queenstown Stn',
 u'Blk 53A CP',
 u'Opp SM Motors Ctr',
 u'Opp SIS Bldg',
 u'Aft Margaret Dr',
 u'Opp Chatsworth Rd',
 u'Aft Rochalie Dr',
 u'British High Comm',
...

In [10]: len(Out[9])
Out[10]: 54
</code></pre>
<p>54 stops, starting in Ghim Moh, through Commonweatlth (<code>C'wealth</code>), Queenstown, and eventually back to Ghim Moh. Looks correct!</p><h3 id="caching">Caching</h3>
<p>Before we go any further, let's address the fact that <code>/BusRoutes</code> takes over a minute to load. We know two things:</p>
<ul>
  <li>Waiting &gt;1 minute for your code to load data before it runs really sucks,  especially when it's buggy and you're trying to figure out what's wrong.</li>
  <li>Bus routes do not change very often</li>
</ul>
<p>Given that, we should be able to save the bus routes we loaded earlier to a file, and just load them from the file next time! Perhaps once a day or once a week we might need to re-download all the routes, but we certainly don't need to do that every time. </p>
<p>With Python, dumping the data structure back to JSON on disk is easy:</p>
<pre><code class="python">In [11]: import json

In [12]: with open("routes.json", "w") as f:
   ....:     f.write(json.dumps(routes))
</code></pre>
<p>While we're at it, we might as well dump the <code>/BusStops</code> and <code>/BusServices</code> responses too:</p>
<pre><code class="python">In [14]: with open("stops.json", "w") as f:
   ....:     f.write(json.dumps(stops))
   ....:

In [15]: services = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusServices")

In [16]: with open("services.json", "w") as f:
   ....:     f.write(json.dumps(services))
   ....:
</code></pre>
<p>Next time, we can just <code>json.loads(open("routes.json").read())</code> and have it all back instantly without needing to wait 1 minute to download. </p><h3 id="an-application">An Application</h3>
<p>Now we know</p>
<ul>
  <li>What all the bus stops are and what they're called</li>
  <li>Which bus routes connect which stops to which other stops</li>
</ul>
<p>It should be relatively easy to write a program that searches for the shortest route between two bus stops, in terms of number of in-between stops. If we had a <code>trip.py</code> file, we may expect someone to run it via</p>
<pre><code class="python">python trip.py "Opp Orchard Stn" "Changi Village Ter"
</code></pre>
<p>And have the program print out what buses to take to which stops. Maybe later we can make a fancy web interface or mobile app, but for now a basic command-line program will do. Before we even think about route-finding, let's make a basic program that takes in user input, loads the data from disk, and does <em>something</em> (anything!) with it. This would ensure we have all the framework in place to put in the fancy trip-planning algorithms later.</p>
<p>To begin with, in <a href="https://www.python.org/">Python</a> you read the arguments from the command line with <code>import sys; sys.argv[1]</code>. We can make a minimal <code>trip.py</code> to verify this:</p>
<pre><code class="python">import sys

start = sys.argv[1]
end = sys.argv[2]

print (start, end)
</code></pre>
<p>Which runs and just echos out the two parameters:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
('Opp Orchard Stn', 'Changi Village Ter')
</code></pre>
<p>Since we have the bus stops, bus services and bus routes already downloaded as JSON files on disk, we can load them quickly and look up e.g. their <code>"BusStopCode"</code>s:</p>
<pre><code class="python">import sys
import json

start = sys.argv[1]
end = sys.argv[2]

stops = json.loads(open("stops.json").read())
stop_desc_map = {stop["Description"]: stop for stop in stops}

print (stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
</code></pre>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
(u'09022', u'99009')
</code></pre>
<p>Although we have the information of what the route of each bus service is, it's in a rather odd format: each service and bus stop is its own entry in one huge list. It would be much more convenient if we could quickly look up what stops were along which route. To do so, we'd need to convert the flat list into a dictionary, with each key being the <code>"ServiceNo"</code> and <code>"Direction"</code> and each value being a list of stops that route stops at.</p>
<pre><code class="python">import sys
import json

start = sys.argv[1]
end = sys.argv[2]

stops = json.loads(open("stops.json").read())
stop_desc_map = {stop["Description"]: stop for stop in stops}
stop_code_map = {stop["BusStopCode"]: stop for stop in stops}

services = json.loads(open("services.json").read())

routes = json.loads(open("routes.json").read())

routes_map = {}
for route in routes:
	key = (route["ServiceNo"], route["Direction"])
	if key not in routes_map:
		routes_map[key] = []
	routes_map[key] += [route]

print [stop_code_map[r["BusStopCode"]]["Description"] for r in routes_map[("111", 1)]]

print (stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
</code></pre>
<p>This works:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
[u'Ghim Moh Ter', u'Blk 12', u'Blk 43', u'Blk 8', u"C'wealth Stn", u'Aft Ch Of Our Saviour', u'Queenstown Stn', u'Blk 53A CP', u'Opp SM Motors Ctr', u'Opp SIS Bldg', u'Aft Margaret Dr', u'Opp Chatsworth Rd', u'Aft Rochalie Dr', u'British High Comm', u'Aft Tomlinson Rd', u'Delfi Orchard', u'Royal Thai Embassy', u'Lucky Plaza', u'Midpoint Orchard', u"Concorde Hotel S'pore", u'Dhoby Ghaut Stn', u'Rendezvous Grand Hotel', u'NTUC Income Ctr', u'Raffles Hotel', u'Suntec Convention Ctr', u'Opp Millenia Twr', u'Opp The Ritz-Carlton', u'Seating Gallery', u'The Esplanade', u'Capitol Bldg', u'SMU', u'YMCA', u'Dhoby Ghaut Stn', u'Winsland Hse', u'Somerset Stn', u'Natl Youth Council', u'Opp Orchard Stn', u'Opp Four Seasons Hotel', u'Bef Tomlinson Rd', u'Grange Residences', u'Opp British High Comm', u'Bef Rochalie Dr', u'Bef Chatsworth Rd', u"Crescent Girls' Sch", u'SIS Bldg', u'Aft SM Motors Ctr', u'Queens Condo', u'Queenstown Stn', u'Blk 42', u"C'wealth Stn", u'Opp Blk 7B', u'Opp Blk 43', u'Blk 13', u'Ghim Moh Ter']
(u'09022', u'99009')
</code></pre>
<p>Though we could use the <code>pprint</code> module to make it more readable:</p>
<pre><code class="python">import sys
import json
import pprint
start = sys.argv[1]
end = sys.argv[2]

stops = json.loads(open("stops.json").read())
services = json.loads(open("services.json").read())
routes = json.loads(open("routes.json").read())

stop_desc_map = {stop["Description"]: stop for stop in stops}
stop_code_map = {stop["BusStopCode"]: stop for stop in stops}

routes_map = {}
for route in routes:
	key = (route["ServiceNo"], route["Direction"])
	if key not in routes_map:
		routes_map[key] = []
	routes_map[key] += [route]

pprint.pprint(
	[stop_code_map[r["BusStopCode"]]["Description"] for r in routes_map[("111", 1)]]
)

print (stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
</code></pre>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
[u'Ghim Moh Ter',
 u'Blk 12',
 u'Blk 43',
 u'Blk 8',
 u"C'wealth Stn",
 u'Aft Ch Of Our Saviour',
 u'Queenstown Stn',
 u'Blk 53A CP',
 u'Opp SM Motors Ctr',
 u'Opp SIS Bldg',
 u'Aft Margaret Dr',
 u'Opp Chatsworth Rd',
 ...]
(u'09022', u'99009')
</code></pre><h2 id="algorithms">Algorithms</h2>
<p>We now have <em>something</em> that can be run from the command line that runs our code to do stuff. We've worked with the API and downloaded a local copy of the data we're interested in for now so we can work with it quickly, and know how to fetch more data from other endpoints if necessary. Our program loads the data, takes user input, and does <em>something</em> with it, even though right now it's just trivially looking up the <code>BusStopCode</code>s of the stops the user inputed, and performing some hardcoded querying of the loaded data to find the stops along Bus 111.</p>
<p>The next step is to finally make it actually do the thing we wanted to do: planning trips between bus stops!</p><h3 id="breadth-first-search">Breadth First Search</h3>
<p>Now we have the data in convenient formats, we're on to the next question: how, given a list of bus stops and a list of bus services that move between them, can we find a trip between two bus stops that minimizes the number of bus stops you cross? This can be rephrased as "given a number of nodes and edges between them, find the path between two nodes with the smallest number of edges". Lucky for us, there are many many known algorithms for this, the most common of which is the <a href="https://en.wikipedia.org/wiki/Breadth-first_search">Breadth First Search</a>. This is an intro-to-computer-science level algorithm, and examples can be found all over, e.g. <a href="http://stackoverflow.com/a/8922151/871202">this one on Stackoverflow</a></p>
<pre><code class="python"># graph is in adjacent list representation
graph = {
    '1': ['2', '3', '4'],
    '2': ['5', '6'],
    '5': ['9', '10'],
    '4': ['7', '8'],
    '7': ['11', '12']
}

def bfs(graph, start, end):
    # maintain a queue of paths
    queue = []
    # push the first path into the queue
    queue.append([start])
    while queue:
        # get the first path from the queue
        path = queue.pop(0)
        # get the last node from the path
        node = path[-1]
        # path found
        if node == end:
            return path
        # enumerate all adjacent nodes, construct a new path and push it into the queue
        for adjacent in graph.get(node, []):
            new_path = list(path)
            new_path.append(adjacent)
            queue.append(new_path)

print bfs(graph, '1', '11')
</code></pre>
<p>This example isn't quite optimal</p>
<ul>
  <li>It's using <code>list.pop(0)</code>, which is <code>O(n)</code>, instead of using a queue where  de-queueing is <code>O(1)</code></li>
  <li>It does not maintain a "seen" set to avoid searching the same nodes multiple  times.</li>
</ul>
<p>Whether that is actually a problem or not depends on the data-set in question. Clearly in the toy network provided, it works. What happens if you feed in our bus-stop network?</p>
<p>It turns out that you can take our earlier <code>route_map</code> and convert it into the same graph format that this code expects relatively straightforwardly:</p>
<pre><code class="python">graph = {}
for service, path in routes_map.items():
    for route_index in range(len(path) - 1):
        key = path[route_index]["BusStopCode"]
        if key not in graph:
            graph[key] = []

        graph[path[route_index]["BusStopCode"]].append(path[route_index + 1]["BusStopCode"])

</code></pre>
<p>This generates a <code>graph</code> that looks like:</p>
<pre><code class="python">{
    u'01012': {u'01013', u'01112', u'01113'},
    u'01013': {u'01112', u'01113'},
    u'01019': {u'02049', u'04159'},
    u'01029': {u'04111', u'04167', u'04168'},
    u'01039': {u'01029'},
    u'01059': {u'01119'},
    u'01109': {u'07551'},
    u'01112': {u'01113', u'01121', u'07551'},
    u'01113': {u'01121'},
    u'01119': {u'01019'},
    u'01121': {u'01211', u'07331'},
    u'01129': {u'01059'},
    ...
}
</code></pre>
<p>Which seems reasonable: spot checking it, stop <code>01059</code> is <code>"Bugis Stn"</code>, and the only stop it has an edge to is <code>1119</code>, or <code>"Bugis Junction"</code>. Although there are many buses out of <code>"Bugis Stn"</code>, all of them go straight to <code>"Bugis Junction"</code>, and so the fact that it only has one edge out is correct. In later iterations we may care about how many buses go between stops, or how long they take, how long's the wait, or how frequent they are, but for now we're just ignoring that and counting "one stop" as "one stop"</p>
<p>It turns out we can re-use this example almost entirely: we just need to feed in our own <code>graph</code> data structure. The entire code, excluding the code for pre-downloading and saving the JSON files, is below:</p>
<pre><code class="python">import sys
import json
import pprint
start = sys.argv[1]
end = sys.argv[2]

print "loading JSON"

stops = json.loads(open("stops.json").read())
services = json.loads(open("services.json").read())
routes = json.loads(open("routes.json").read())

print "Initializing tables"
stop_desc_map = {stop["Description"]: stop for stop in stops}
stop_code_map = {stop["BusStopCode"]: stop for stop in stops}
routes_map = {}

for route in routes:
    key = (route["ServiceNo"], route["Direction"])
    if key not in routes_map:
        routes_map[key] = []
    routes_map[key] += [route]

print "Initializing Graph"
graph = {}
for service, path in routes_map.items():
    for route_index in range(len(path) - 1):
        key = path[route_index]["BusStopCode"]
        if key not in graph:
            graph[key] = set()
        graph[path[route_index]["BusStopCode"]].add(path[route_index + 1]["BusStopCode"])

print "Running BFS"

def bfs(graph, start, end):
    # maintain a queue of paths
    queue = []
    # push the first path into the queue
    queue.append([start])
    while queue:
        # get the first path from the queue
        path = queue.pop(0)
        # get the last node from the path
        node = path[-1]
        # path found
        if node == end:
            return path
        # enumerate all adjacent nodes, construct a new path and push it into the queue
        for adjacent in graph.get(node, []):
            new_path = list(path)
            new_path.append(adjacent)
            queue.append(new_path)

pprint.pprint(
    bfs(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
)
</code></pre>
<p>You can run this, and find... it never terminates. It reaches, the <code>"Running BFS"</code> step, and then spends forever running the BFS. If you add a print statement to see how long the <code>path</code> is, it never goes much past <code>6</code> or <code>7</code> deep. It seems that the earlier inefficiencies we found in the search algorithm really are, in fact, slowing things down. You can leave it running for an hour and, while it's vigorously searching, it will never find a path between two bus stops more than a handful of stops apart! </p>
<p>Luckily it's relatively straightforward swapping out the <code>[]</code> list for a <code>Queue</code> to make de-queueing efficient, and adding a <code>seen</code> set to avoid searching each node more than once:</p>
<pre><code class="diff">haoyi-mbp:test haoyi$ git diff
diff --git a/trip.py b/trip.py
index 9eb8380..186cb98 100644
--- a/trip.py
+++ b/trip.py
@@ -48,23 +48,29 @@ for service, path in routes_map.items():
 print "Running BFS"

 def bfs(graph, start, end):
+    from Queue import Queue
+    seen = set()
     # maintain a queue of paths
-    queue = []
+    queue = Queue()
     # push the first path into the queue
-    queue.append([start])
+    queue.put([start])
     while queue:
         # get the first path from the queue
-        path = queue.pop(0)
+        path = queue.get()
+
         # get the last node from the path
         node = path[-1]
         # path found
         if node == end:
             return path
+        if node in seen:
+            continue
+        seen.add(node)
         # enumerate all adjacent nodes, construct a new path and push it into the queue
         for adjacent in graph.get(node, []):
             new_path = list(path)
             new_path.append(adjacent)
-            queue.append(new_path)
+            queue.put(new_path)
</code></pre>
<p>And that makes the code finish almost instantly, printing e.g.</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
loading JSON
Initializing  tables
Initializing Graph
Running BFS
[u'09022',
 u'13199',
 u'E1301',
 u'13191',
 u'09212',
 u'09213',
 u'E4022',
 u'40231',
 u'PIE',
 u'ECP',
 u'95151',
 ...
 u'99011',
 u'99021',
 u'99031',
 u'99041',
 u'99139',
 u'99009']
</code></pre>
<p>Since I think in <code>"Description"</code>s better than in <code>"BusStopCode"</code>s, I'll print out all those instead:</p>
<pre><code class="python">path = bfs(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
pprint.pprint([stop_code_map[stop_code]["Description"] for stop_code  in path ])   
</code></pre>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
loading JSON
Initializing  tables
Initializing Graph
Running BFS
[u'Opp Orchard Stn',
 u'Opp Paterson Lodge',
 u'Non Stop',
 u'Paterson Lodge',
 u'Royal Plaza On Scotts',
 u'Thong Teck Bldg',
 u'Non Stop',
 u'Raffles Town Club',
 u'Express',
 u'Express',
 u'Airport Police Stn',
 ...
 u'LP 80',
 u'Bef Sch Of Commando',
 u'Bef Cranwell Rd',
 u'Opp Maranatha B-P Ch',
 u'Aft Changi Golf Course',
 u'Blk 5',
 u'Changi Village Ter']
</code></pre>
<p>Now we know what the shortest set of bus stops is, but we don't actually know what buses will get us along that set of bus stops! It's pretty easy to write code that will figure that out for us though:</p>
<pre><code class="python">path = bfs(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
def find_service(i):
    for (service, direction), route in routes_map.items():
        for j in range(len(route)-1):
            if path[i] == route[j]["BusStopCode"] and path[i+1] == route[j+1]["BusStopCode"]:
                return (
                	service, 
                	stop_code_map[path[i]]["Description"],
                	stop_code_map[path[i + 1]]["Description"]
            	)

for i in range(len(path) - 1):
    print find_service(i)
print len(path), "stops"
</code></pre>
<ul>
  <li><strong>Note</strong>: this is a relatively hacky way of reverse-engineering which buses  to take between the various stops, as the current algorithm doesn't keep  track of what services it took: it only knows what <em>stops</em> are connected with  what other stops. Furthermore, since the current algorithm doesn't take into  account the time taken to transfer buses, it will definitely end up with a  route with far too many transfers. This is something we'll fix later when we  teach it to understand <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#transfer-cost">Transfer Cost</a>s.</li>
</ul>
<p>Nevertheless, running this gets us an acceptable approximation of what bus services we <em>could</em> take to follow that route.</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
loading JSON
Initializing  tables
Initializing Graph
Running BFS
(u'14', u'Opp Orchard Stn', u'Opp Paterson Lodge')
(u'NR5', u'Opp Paterson Lodge', u'Non Stop')
(u'NR6', u'Non Stop', u'Paterson Lodge')
(u'5', u'Paterson Lodge', u'Royal Plaza On Scotts')
(u'NR3', u'Royal Plaza On Scotts', u'Thong Teck Bldg')
(u'971E', u'Thong Teck Bldg', u'Non Stop')
(u'971E', u'Non Stop', u'Raffles Town Club')
(u'NR3', u'Raffles Town Club', u'Express')
(u'858', u'Express', u'Express')
(u'858', u'Express', u'Airport Police Stn')
(u'34', u'Airport Police Stn', u'Bef Changi Airport PTB3')
(u'34', u'Bef Changi Airport PTB3', u'Changi Airport PTB3')
(u'34', u'Changi Airport PTB3', u'Changi Airport PTB1')
(u'34', u'Changi Airport PTB1', u'Changi Airport PTB2')
(u'34', u'Changi Airport PTB2', u'Aft Changi Airport PTB2')
(u'34', u'Aft Changi Airport PTB2', u'Near SATS Flight Kitchen')
(u'34', u'Near SATS Flight Kitchen', u'At Track 33 Int')
(u'53', u'At Track 33 Int', u'Blk 149A')
(u'59', u'Blk 149A', u'Blk 275')
(u'59', u'Blk 275', u'Aft Pasir Ris Dr 3')
(u'59', u'Aft Pasir Ris Dr 3', u'Opp Loyang Valley')
(u'59', u'Opp Loyang Valley', u'Loyang Ind Est')
(u'59', u'Loyang Ind Est', u'Bef Loyang Way')
(u'59', u'Bef Loyang Way', u'Opp Engine Test Facility')
(u'59', u'Opp Engine Test Facility', u'LP 80')
(u'59', u'LP 80', u'Bef Sch Of Commando')
(u'59', u'Bef Sch Of Commando', u'Bef Cranwell Rd')
(u'59', u'Bef Cranwell Rd', u'Opp Maranatha B-P Ch')
(u'59', u'Opp Maranatha B-P Ch', u'Aft Changi Golf Course')
(u'59', u'Aft Changi Golf Course', u'Blk 5')
(u'59', u'Blk 5', u'Changi Village Ter')
30 stops
</code></pre>
<p>Looks like it's asking us to take a mish-mash of routes at the start, then bus 34 from the <code>'Airport Polic Stn'</code> to <code>'Near SATS Flight Kitchen'</code>, then 59 to <code>'Changi Village Ter'</code>. It's not a very <em>good</em> route, but it's a route!</p>
<p>Success!</p><h3 id="improvements">Improvements</h3>
<p>There are a bunch of obvious limitations with the above trip planner:</p>
<ul>
  <li>
  <p>It picks buses which aren't even running at the same time, like the <code>NR5</code>  services which only run at night!</p></li>
  <li>
  <p>It makes you change between lots of buses to try and minimize the number of  stops you cross, without counting the time wasted waiting for buses.</p></li>
  <li>
  <p>It doesn't count how far the bus stops are from each other; some are closer  than others</p></li>
</ul>
<p>Luckily, all of these are solvable. The average wait between buses is available as part of the <code>/BusServices</code> endpoint that we've saved into <code>services.json</code>, as the various <code>_Freq</code> fields:</p>
<pre><code class="python">In [3]: import json

In [4]: services = json.loads(open("services.json").read())

In [5]: services[0]
Out[5]:
{u'AM_Offpeak_Freq': u'7-15',
 u'AM_Peak_Freq': u'10-14',
 u'Category': u'TRUNK',
 u'DestinationCode': u'16009',
 u'Direction': 1,
 u'LoopDesc': u'',
 u'Operator': u'SBST',
 u'OriginCode': u'75009',
 u'PM_Offpeak_Freq': u'13-18',
 u'PM_Peak_Freq': u'13-15',
 u'ServiceNo': u'10'}
</code></pre>
<p>While the distance between bus stops and the first/last bus for each service at each stop is available under the <code>/BusRoutes</code> endpoint or <code>routes.json</code> file:</p>
<pre><code class="python">In [6]: routes = json.loads(open("routes.json").read())

In [7]: routes[0]
Out[7]:
{u'BusStopCode': u'75009',
 u'Direction': 1,
 u'Distance': 0,
 u'Operator': u'SBST',
 u'SAT_FirstBus': u'0500',
 u'SAT_LastBus': u'2300',
 u'SUN_FirstBus': u'0500',
 u'SUN_LastBus': u'2300',
 u'ServiceNo': u'10',
 u'StopSequence': 1,
 u'WD_FirstBus': u'0500',
 u'WD_LastBus': u'2300'}
</code></pre>
<p>Which contains the <code>_FirstBus</code> and <code>_LastBus</code> for weekdays and weekends, as well as the <code>'Distance'</code> along the route each stop is which can be subtracted to find the distance between stops.</p><h3 id="dijkstras-algorithm">Dijkstra's Algorithm</h3>
<p>The previous version of our trip planner used a <a href="https://en.wikipedia.org/wiki/Breadth-first_search">Breadth First Search</a>, which works great if every edge between two bus stops has the same cost. If the cost of each edge varies, we need to use something more flexible: lucky for us, there are existing algorithms for this! </p>
<p>One of which that students learn in their first Algorithms class is <a href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra's Algorithm</a>. It is essentially identical to a breadth first search, except that instead of using a simple <code>Queue</code> to organize the nodes to visit, it uses a <a href="https://en.wikipedia.org/wiki/Priority_queue">Priority Queue</a>. The end result is instead of exploring the nodes in the order that they are seen, Dijkstra's explores them in order of how far away they are from the starting node according to an arbitrary "cost" function. If we use "distance between bus stops" as the cost of each edge, we'll find the shortest route to take, in terms of kilometers traveled instead of bus-stops crossed.</p>
<p>To do this, we will change our <code>graph</code> to instead of storing a dictionary of:</p>
<pre><code class="python">{bus_stop_code: {adjacent_bus_stop_codes}}
</code></pre>
<p>To instead store:</p>
<pre><code class="python">{bus_stop_code: {adjacent_bus_stop_codes: distance_to_adjacent_bus_stop}}
</code></pre>
<p>Via:</p>
<pre><code class="diff">@@ -34,21 +30,27 @@ for service, path in routes_map.items():
     for route_index in range(len(path) - 1):
         key = path[route_index]["BusStopCode"]
         if key not in graph:
-            graph[key] = set()
-        graph[path[route_index]["BusStopCode"]].add(path[route_index + 1]["BusStopCode"])
+            graph[key] = {}
+        curr_route_stop = path[route_index]
+        next_route_stop = path[route_index + 1]
+        curr_distance = curr_route_stop["Distance"]
+        next_distance = next_route_stop["Distance"]
+        distance = next_distance - curr_distance
+        assert distance &gt;= 0, (curr_route_stop, next_route_stop)
+        graph[curr_route_stop["BusStopCode"]][next_route_stop["BusStopCode"]] = distance

 print "Running BFS"

</code></pre>
<p>As you can see, instead of constructing the a <code>set()</code> for the "next stops" for each bus stop we now construct a dictionary <code>{}</code> which will contain the next stops <em>along with the distance to each one</em>.</p>
<ul>
  <li><strong>Note</strong>: The <code>"Distance"</code> attribute on each item is the distance of that  stop <em>from the start of that service's route</em>, and <em>not</em> the distance from  the previous stop. Thus if we want the distance from one stop to the next, we  need to subtract the two <code>"Distance"</code> attributes to get the distance the bus  would need to travel between the stops.</li>
</ul>
<p>At the same time, we need to modify our <code>bfs</code> to use a <a href="https://en.wikipedia.org/wiki/Priority_queue">Priority Queue</a>, which is the Python <a href="https://docs.python.org/2/library/heapq.html">heapq</a> module, to turn it into a <code>dijkstras</code> search:</p>
<pre><code class="diff"> print "Running BFS"

-def bfs(graph, start, end):
-    from Queue import Queue
+def dijkstras(graph, start, end):
+    import heapq
     seen = set()
     # maintain a queue of paths
-    queue = Queue()
+    queue = []
     # push the first path into the queue
-    queue.put([start])
+    heapq.heappush(queue, (0, [start]))
     while queue:
         # get the first path from the queue
-        path = queue.get()
+        (curr_distance, path) = heapq.heappop(queue)

         # get the last node from the path
         node = path[-1]
@@ -59,12 +61,12 @@ def bfs(graph, start, end):
             continue
         seen.add(node)
         # enumerate all adjacent nodes, construct a new path and push it into the queue
-        for adjacent in graph.get(node, []):
+        for adjacent, distance in graph.get(node, {}).items():
             new_path = list(path)
             new_path.append(adjacent)
-            queue.put(new_path)
+            heapq.heappush(queue, (curr__distance, new_path))

-path = bfs(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
+path = dijkstras(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
</code></pre>
<p>This is a relatively shallow conversion: we replace the <code>Queue</code> with <code>heapq</code>, and rename all the methods calls to use the <code>heapq</code> equivalents. In order to ensure the <code>heapq</code> sorts things in the correct order, we store tuples of </p>
<pre><code class="python">(total_distance, path)
</code></pre>
<p>As each element in the <code>heapq</code>.</p>
<p>This looks correct, but if you run this, you will find it crashes:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
loading JSON
Initializing  tables
Initializing Graph
Traceback (most recent call last):
  File "trip.py", line 37, in &lt;module&gt;
    distance = next_distance - curr_distance
TypeError: unsupported operand type(s) for -: 'NoneType' and 'float'
</code></pre>
<p>How is that?</p><h4 id="more-sanity-checking">More Sanity Checking</h4>
<p>Presumably some of our <code>'Distance'</code> fields are <code>None</code> instead of having a sensible value. We can fix that by defaulting to <code>0</code> if it's not found:</p>
<pre><code class="diff">haoyi-mbp:test haoyi$ git diff
diff --git a/trip.py b/trip.py
index 49f1ce2..a274b69 100644
--- a/trip.py
+++ b/trip.py
@@ -39,8 +39,8 @@ for service, path in routes_map.items():
             graph[key] = {}
         curr_route_stop = path[route_index]
         next_route_stop = path[route_index + 1]
-        curr_distance = curr_route_stop["Distance"]
-        next_distance = next_route_stop["Distance"]
+        curr_distance = curr_route_stop["Distance"] or 0
+        next_distance = next_route_stop["Distance"] or curr_distance
         distance = next_distance - curr_distance
         assert distance &gt;= 0, (curr_route_stop, next_route_stop)
         graph[curr_route_stop["BusStopCode"]][next_route_stop["BusStopCode"]] = distance
</code></pre>
<p>But we still find it fails the <code>next_distance - curr_distance</code> check:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
loading JSON
Initializing  tables
Initializing Graph
Traceback (most recent call last):
  File "trip.py", line 38, in &lt;module&gt;
    assert distance &gt;= 0, (curr_distance, next_distance)
AssertionError: (9.1, 1.3)
</code></pre>
<p>How odd, why is one stop at distance <code>9.1</code> and the next at distance <code>1.3</code>? In order to try We can make our assert more verbxose:</p>
<pre><code class="diff">haoyi-mbp:test haoyi$ git diff
diff --git a/trip.py b/trip.py
index 07ce374..031df9f 100644
--- a/trip.py
+++ b/trip.py
@@ -36,7 +36,7 @@ for service, path in routes_map.items():
         curr_distance = curr_route_stop["Distance"] or 0
         next_distance = next_route_stop["Distance"] or curr_distance_
         distance = next_distance - curr_distance
-        assert distance &gt;= 0, (curr_distance, next_distance)
+        assert distance &gt;= 0, (curr_route_stop, next_route_stop)
         graph[curr_route_stop["BusStopCode"]][next_route_stop["BusStopCode"]] = distance

 print "Running BFS"
</code></pre>
<p>In which case we get:</p>
<pre><code class="python">AssertionError: ({
    u'ServiceNo': u'34', 
    u'Direction': 1, 
    u'Distance': 9.1, 
    u'SUN_LastBus': u'0006', 
    u'StopSequence': 4, 
    u'WD_LastBus': u'0009', 
    u'Operator': u'SBST', 
    u'BusStopCode': u'76059', 
    u'SAT_LastBus': u'0006', 
    u'WD_FirstBus': u'0534', 
    u'SUN_FirstBus': u'0547', 
    u'SAT_FirstBus': u'0549'
}, {
    u'ServiceNo': u'34', 
    u'Direction': 1, 
    u'Distance': 1.3, 
    u'SUN_LastBus': u'2347', 
    u'StopSequence': 4, 
    u'WD_LastBus': u'2348', 
    u'Operator': u'SBST', 
    u'BusStopCode': u'65079', 
    u'SAT_LastBus': u'2348', 
    u'WD_FirstBus': u'0533', 
    u'SUN_FirstBus': u'0532', 
    u'SAT_FirstBus': u'0532'
})
</code></pre>
<p>That's really odd! We have two stops by service <code>'34'</code>, in the same direction (<code>1</code>), both with <code>'StopSequence': 4</code>, but they appear to be stopping at different bus stops (<code>76059</code> and <code>65079</code>) and have different <code>_FirstBus</code>/<code>_LastBus</code> times! How could that be? Looking up this bus <a href="http://www.transitlink.com.sg/eservice/eguide/service_route.php?service=34">online</a>, it seems that these are two valid stops along vastly different sections of the bus route. Curious, we may decide to investigate the data further to see what's up. We can easily load it into the <a href="https://ipython.org/install.html">IPython</a> shell:</p>
<pre><code class="python">In [1]: import json

In [2]: routes = json.loads(open("routes.json").read())

In [3]: routes_map = {}

In [4]: for route in routes:
        key = (route["ServiceNo"], route["Direction"])
        if key not in routes_map:
                routes_map[key] = []
        routes_map[key] += [route]
   ...:

In [5]: len(routes_map[('34', 1)])
Out[5]: 51

In [6]: routes_map[('34', 1)][0].keys()
Out[6]:
[u'ServiceNo',
 u'Direction',
 u'Distance',
 u'SUN_LastBus',
 u'StopSequence',
 u'WD_LastBus',
 u'Operator',
 u'BusStopCode',
 u'SAT_LastBus',
 u'WD_FirstBus',
 u'SUN_FirstBus',
 u'SAT_FirstBus']
</code></pre>
<p>Since we know that <code>'StopSequence'</code> and <code>'Distance'</code> are the weird things, let's pull up both those attributes for bus <code>34</code> to see what they look like:</p>
<pre><code class="python">In [7]: [(r["StopSequence"], r["Distance"]) for r in routes_map[('34', 1)]]
Out[7]:
[(1, 0),
 (2, 0.6),
 (3, 1),
 (4, 9.1),
 (4, 1.3),
 (5, 1.7),
 (6, 5.7),
 (7, 6.1),
 (8, 6.5),
 (9, 7),
 (10, 7.3),
 (11, 7.9),
 (12, 8.3),
 (13, 8.6),
 (15, 9.6),
 (16, 10.1),
 (17, 10.6),
 (18, 11),
 (19, 11.4),
 (20, 12),
 (21, 12.3),
 (22, None),
 (23, 16.6),
 (24, 17.1),
 (25, 18.5),
 (26, 19.3),
 (27, 20.1),
 (28, 21.2),
 (29, 21.9),
 (30, None),
 (31, 26.4),
 (32, 26.7),
 (33, 27.3),
 (34, 27.8),
 (35, 28.3),
 (36, 28.8),
 (37, 29.4),
 (38, 29.9),
 (39, 30.4),
 (40, 30.8),
 (41, 31.1),
 (42, 31.7),
 (43, 32),
 (44, 32.6),
 (45, 33),
 (46, 33.3),
 (47, 37.3),
 (48, 37.8),
 (49, 38.1),
 (50, 38.4),
 (51, 38.9)]
</code></pre>
<p>That's really odd! We have a bunch of <code>None</code>s where the dataset doesn't give us the ditance, and we also have <em>two</em> <code>4</code>s for <code>'StopSequence'</code> and do not have a stop <code>14</code> at all! Obviously someone made a mistake in the data and called stop #14 stop #4. But what can we do about it? </p><h4 id="working-around">Working Around</h4>
<p>The first thing to do is to work around it and hope not too may other issues crop up:</p>
<pre><code class="diff">haoyi-mbp:test haoyi$ git diff
diff --git a/trip.py b/trip.py
index 031df9f..49f1ce2 100644
--- a/trip.py
+++ b/trip.py
@@ -21,12 +21,18 @@ for route in routes:
     key = (route["ServiceNo"], route["Direction"])
     if key not in routes_map:
         routes_map[key] = []
-
+    # hack around broken data
+    if (route["StopSequence"] == 4
+            and route["Distance"] == 9.1
+            and key == ("34", 1)):
+        route["StopSequence"] = 14
     routes_map[key] += [route]

 print "Initializing Graph"
 graph = {}
 for service, path in routes_map.items():
+    # hack around broken data
+    path.sort(key = lambda r: r["StopSequence"])
     for route_index in range(len(path) - 1):
         key = path[route_index]["BusStopCode"]
         if key not in graph:
</code></pre>
<p>The goal of this change is to manually fix the incorrect <code>route</code> item while we're building our <code>routes_map</code>. Not only do we need to change its <code>StopSequence</code>, we also need to re-sort things to make sure that the order the stops appear in matches up with the fixed <code>StopSequence</code>.</p>
<p>If we run it, we get a seemingly-valid route!</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter"
loading JSON
Initializing  tables
Initializing Graph
Running BFS
(u'14', u'Opp Orchard Stn', u'Opp Paterson Lodge')
(u'54', u'Opp Paterson Lodge', u'Bef Zion Full Gospel Ch')
(u'564', u'Bef Zion Full Gospel Ch', u'The Trillium')
(u'564', u'The Trillium', u'Aft Furama RiverFront')
(u'564', u'Aft Furama RiverFront', u'Opp Maritime Hse')
(u'75', u'Opp Maritime Hse', u'Opp Sth Pt')
(u'75', u'Opp Sth Pt', u'Hub Synergy Pt')
(u'10', u'Hub Synergy Pt', u'Aft Capital Twr')
(u'10', u'Aft Capital Twr', u'Opp The Ogilvy Ctr')
(u'106', u'Opp The Ogilvy Ctr', u'The Sail')
(u'97', u'The Sail', u'Marina Bay Financial Ctr')
(u'513', u'Marina Bay Financial Ctr', u'Express')
(u'513', u'Express', u'Laguna Natl C. Club')
(u'513', u'Laguna Natl C. Club', u'Opp Global Logistics Ctr')
(u'513', u'Opp Global Logistics Ctr', u'DB Schenker')
(u'513', u'DB Schenker', u"Opp S'pore Expo")
(u'20', u"Opp S'pore Expo", u'Opp Expo Halls 1/2/3')
(u'12', u'Opp Expo Halls 1/2/3', u'Opp Expo Halls 4/5/6')
(u'24', u'Opp Expo Halls 4/5/6', u'Bef Tropicana Condo')
(u'5', u'Bef Tropicana Condo', u'Opp Changi Ct')
(u'5', u'Opp Changi Ct', u'Opp Mera Terr P/G')
(u'4N', u'Opp Mera Terr P/G', u'Blk 149A')
(u'59', u'Blk 149A', u'Blk 275')
(u'59', u'Blk 275', u'Aft Pasir Ris Dr 3')
(u'59', u'Aft Pasir Ris Dr 3', u'Opp Loyang Valley')
(u'59', u'Opp Loyang Valley', u'Loyang Ind Est')
(u'59', u'Loyang Ind Est', u'Bef Loyang Way')
(u'59', u'Bef Loyang Way', u'Opp Engine Test Facility')
(u'59', u'Opp Engine Test Facility', u'LP 80')
(u'59', u'LP 80', u'Bef Sch Of Commando')
(u'59', u'Bef Sch Of Commando', u'Bef Cranwell Rd')
(u'59', u'Bef Cranwell Rd', u'Opp Maranatha B-P Ch')
(u'59', u'Opp Maranatha B-P Ch', u'Aft Changi Golf Course')
(u'59', u'Aft Changi Golf Course', u'Blk 5')
(u'59', u'Blk 5', u'Changi Village Ter')
36 stops
</code></pre>
<p>As you can see, we found a route taking 36 stops instead of the 30 stop route the earlier trip-planner found. This is because we're now trying to minimize the <em>distance traveled</em> rather than the <em>number of stops</em>. Thus it makes sense that the number of stops would suffer slightly. We don't currently have a way to track what distance the routes <em>actually</em> cover, but we'll add that capability <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#transfer-cost">later</a>. </p><h3 id="service-hours">Service Hours</h3>
<p>Not every bus runs at every hour, but the above trip-planner does not know that. That is why it includes the <code>4N</code> "Nite Owl" buses, as part of the overall route, when those are run at odd hours when most other buses aren't running. To do that, you have to make use of the <code>_FirstBus</code> and <code>_LastBus</code> properties available on each entry in <code>/BusRoutes</code> or <code>routes.json</code>:</p>
<pre><code class="python">In [2]: import json

In [3]: routes = json.loads(open("routes.json").read())

In [4]: routes[0]
Out[4]:
{u'BusStopCode': u'75009',
 u'Direction': 1,
 u'Distance': 0,
 u'Operator': u'SBST',
 u'SAT_FirstBus': u'0500',
 u'SAT_LastBus': u'2300',
 u'SUN_FirstBus': u'0500',
 u'SUN_LastBus': u'2300',
 u'ServiceNo': u'10',
 u'StopSequence': 1,
 u'WD_FirstBus': u'0500',
 u'WD_LastBus': u'2300'}
</code></pre>
<p>Our strategy will be simple: ask the user to tell us what time he's making the trip, and ignore buses which are not running at that time! For now let's assume it's a weekday, and thus only care about <code>WD_FirstBus</code>/<code>WD_LastBus</code>. If we wanted to add support for <code>SAT</code>/<code>SUN</code>, we could do that later.</p>
<p>Here we make use of <code>sys.argv[3]</code> to get the desired time from the user, and compare it to the <code>first_bus</code> and <code>last_bus</code> to make sure the bus is active:</p>
<pre><code class="diff">haoyi-mbp:test haoyi$ git diff
diff --git a/trip.py b/trip.py
index a274b69..ec77bab 100644
--- a/trip.py
+++ b/trip.py
@@ -4,6 +4,7 @@ import pprint

 start = sys.argv[1]
 end = sys.argv[2]
+current_time = int(sys.argv[3])

 print "loading JSON"

@@ -18,6 +19,18 @@ stop_code_map = {stop["BusStopCode"]: stop for stop in stops}
 routes_map = {}

 for route in routes:
+    try:
+        first_bus = int(route["WD_FirstBus"])
+        last_bus = int(route["WD_LastBus"])
+    except:
+        continue
+    if first_bus &lt;= last_bus:
+        if not (first_bus &lt;= current_time &lt;= last_bus):
+            continue
+    if first_bus &gt; last_bus:
+        if (last_bus &lt;= current_time &lt;= first_bus):
+            continue
+
     key = (route["ServiceNo"], route["Direction"])
     if key not in routes_map:
         routes_map[key] = []
</code></pre>
<p>Now, if we ask for a trip at <code>1700</code> hours or 5pm, we don't get any of those <code>4N</code> Nite Owl buses:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter" 1700
loading JSON
Initializing  tables
Initializing Graph
Running BFS
(u'14', u'Opp Orchard Stn', u'Opp Paterson Lodge')
(u'54', u'Opp Paterson Lodge', u'Bef Zion Full Gospel Ch')
(u'54', u'Bef Zion Full Gospel Ch', u'Opp ERC Inst')
(u'54', u'Opp ERC Inst', u'Airview Twr')
(u'54', u'Airview Twr', u'Aft AA Ctr')
(u'54', u'Aft AA Ctr', u'Opp Mohd Sultan Rd')
(u'54', u'Opp Mohd Sultan Rd', u'Opp Liang Ct')
(u'54', u'Opp Liang Ct', u'Opp Clarke Quay')
(u'195', u'Opp Clarke Quay', u'Supreme Ct')
(u'195', u'Supreme Ct', u'Pan Pacific Hotel')
(u'97', u'Pan Pacific Hotel', u'Marina Ctr Ter')
(u'36', u'Marina Ctr Ter', u'Aft Raffles Blvd')
(u'36', u'Aft Raffles Blvd', u'Fort Rd JUNCTION/ECP')
(u'518', u'Fort Rd JUNCTION/ECP', u'Eastern Lagoon II')
(u'518', u'Eastern Lagoon II', u'Aft Bedok Sth Ave 1')
(u'518', u'Aft Bedok Sth Ave 1', u'Opp Kg Chai Chee CC')
(u'17A', u'Opp Kg Chai Chee CC', u'Blk 521')
(u'17A', u'Blk 521', u'Blk 516')
(u'17A', u'Blk 516', u'Opp Fengshan Pr Sch')
(u'18', u'Opp Fengshan Pr Sch', u'Blk 506')
(u'67', u'Blk 506', u'Opp Blk 761')
(u'67', u'Opp Blk 761', u'Opp The Clearwater Condo')
(u'22', u'Opp The Clearwater Condo', u'Opp Bedok Reform Trg Ctr')
(u'59', u'Opp Bedok Reform Trg Ctr', u'Opp SAFRA Tampines')
(u'59', u'Opp SAFRA Tampines', u'Blk 141')
(u'59', u'Blk 141', u'Opp The Holy Trinity Ch')
(u'59', u'Opp The Holy Trinity Ch', u'Blk 206')
(u'59', u'Blk 206', u'Tampines East CC')
(u'59', u'Tampines East CC', u'Tampines JC')
(u'59', u'Tampines JC', u'Blk 497D')
(u'59', u'Blk 497D', u'Blk 149A')
(u'59', u'Blk 149A', u'Blk 275')
(u'59', u'Blk 275', u'Aft Pasir Ris Dr 3')
(u'59', u'Aft Pasir Ris Dr 3', u'Opp Loyang Valley')
(u'59', u'Opp Loyang Valley', u'Loyang Ind Est')
(u'59', u'Loyang Ind Est', u'Bef Loyang Way')
(u'59', u'Bef Loyang Way', u'Opp Engine Test Facility')
(u'59', u'Opp Engine Test Facility', u'LP 80')
(u'59', u'LP 80', u'Bef Sch Of Commando')
(u'59', u'Bef Sch Of Commando', u'Bef Cranwell Rd')
(u'59', u'Bef Cranwell Rd', u'Opp Maranatha B-P Ch')
(u'59', u'Opp Maranatha B-P Ch', u'Aft Changi Golf Course')
(u'59', u'Aft Changi Golf Course', u'Blk 5')
(u'59', u'Blk 5', u'Changi Village Ter')
45 stops
</code></pre>
<p>No more <code>4N</code> bus being used for part of the route! Instead, we take a different collection of buses.</p><h3 id="transfer-cost">Transfer Cost</h3>
<p>As you may know, changing buses is not free! You always have to wait for the next bus to arrive, which certainly takes more time than staying on your current bus. The above trip-planner does not take this into account, and asks you to change buses every 2-5 stops, to try and minimize the distance traveled, but we <em>actually</em> want to minimize the time taken, which includes that spent changing buses. For that matter, apart from transfering, merely <em>stopping</em> at a bus stop has non-trivial cost! That too should be accounted for.</p>
<p>Let's consider bus transfers first. If I am at the <code>Opp Orchard Stn</code> stop, and I want to get to <code>Grange Residences</code>, I can take <code>111</code>, <code>132</code>, 7, or many other services. On the other hand, if I'm <em>already</em> on <code>111</code> when I reach <code>Opp Orchard Stn</code>, it would be foolish to change bus! Changing bus has a cost, and it should be part of my calculation when planning a trip.</p>
<p>The key insight here is that it doesn't just matter what stop you are at, but also what bus you are currently on. Thus the <code>key</code> of our <code>graph</code> should be a tuple of <code>(current_stop, current_service)</code>:</p>
<pre><code class="diff">@@ -56,8 +57,9 @@ for service, path in routes_map.items():
         next_distance = next_route_stop["Distance"] or curr_distance
         distance = next_distance - curr_distance
         assert distance &gt;= 0, (curr_route_stop, next_route_stop)
-        graph[curr_route_stop["BusStopCode"]][next_route_stop["BusStopCode"]] = distance
+        curr_code = curr_route_stop["BusStopCode"]
+        next_code = next_route_stop["BusStopCode"]
+        graph[curr_code][(next_code, service)] = distance

 print "Running BFS"
</code></pre>
<p>Here I'm changing the <code>graph</code> from:</p>
<pre><code class="python">{bus_stop_code: {adjacent_bus_stop_codes: distance_to_adjacent_bus_stop}}
</code></pre>
<p>to:</p>
<pre><code class="python">{bus_stop_code: {(adjacent_bus_stop_codes, service): distance_to_adjacent_bus_stop}}
</code></pre>
<p>The reason for this is that depending on what bus service we take to the next stop, it could have varying amounts of cost depending on what bus service I am currently on! Thus I have to model all possible services to the next adjacent stop, and not just the fact that "this stop is adjacent".</p>
<p>The next change would be to the <code>dijkstras</code> function:</p>
<pre><code class="diff">@@ -67,36 +69,40 @@ def dijkstras(graph, start, end):
     # maintain a queue of paths
     queue = []
     # push the first path into the queue
-    heapq.heappush(queue, (0, [start]))
+    heapq.heappush(queue, (0, 0, 0, [(start, None)]))
     while queue:
         # get the first path from the queue
-        (curr_distance, path) = heapq.heappop(queue)
+        (curr_cost, curr_distance, curr_transfers, path) = heapq.heappop(queue)

         # get the last node from the path
-        node = path[-1]
+        (node, curr_service) = path[-1]
+
         # path found
         if node == end:
-            return path
-        if node in seen:
+            return (curr_cost, curr_distance, curr_transfers, path)
+
+        if (node, curr_service) in seen:
             continue
-        seen.add(node)
+
+        seen.add((node, curr_service))
</code></pre>
<p>There are a few changes here:</p>
<ol>
  <li>
  <p>There is a new set of <code>cost</code> variables, which is used to sort the elements  in our <a href="https://en.wikipedia.org/wiki/Priority_queue">Priority Queue</a> instead of <code>distance</code>. We also maintain a  <code>curr_transfers</code> variable keepign track of how many transfers we've done  between bus services</p></li>
  <li>
  <p>The <code>path</code> we're storing includes the current service (or <code>None</code>) in  addition to the bus stops</p></li>
  <li>
  <p><code>seen</code> now contains tuples of <code>(node, curr_service)</code>: as described earlier,  how long it takes to get to adjacent stops depends not just on what stop  we're at but what service we're on when we get there in case we need to  transfer. That means even if we've seen a stop on a particular service,  we can't immediately discount it in case there's some other bus service  passing through that stop that could still be a viable route.</p></li>
</ol>
<p>Next, we have the changes to the iteration from node to node:</p>
<pre><code class="diff">         # enumerate all adjacent nodes, construct a new path and push it into the queue
-        for adjacent, distance in graph.get(node, {}).items():
-            new_path = list(path)
-            new_path.append(adjacent)
-            heapq.heappush(queue, (distance + curr_distance, new_path))
-
+        for (adjacent, service), distance in graph.get(node, {}).items():
+            new_path = list(path)
+            new_path.append((adjacent, service))
+            new_distance = curr_distance + distance
+            new_cost = distance + curr_cost
+            new_transfers = curr_transfers
+            if curr_service != service:
+                new_cost += cost_per_transfer
+                new_transfers += 1
+            new_cost += cost_per_stop
+
+            heapq.heappush(queue, (new_cost, new_distance, new_transfers, new_path))
</code></pre>
<p>Here, we're replacing the old code which simply kept track of distance, with slightly more complex code that tracks three things:</p>
<ul>
  <li>The <code>distance</code></li>
  <li>The <code>cost</code>: includes the distance, and any additional cost we add due to  transfers or passing through individual bus stops</li>
  <li>The number of <code>transfers</code>, just for reporting at the end.</li>
</ul>
<p>Lastly, we need to get the <code>cost_per_transfer</code> and <code>cost_per_stop</code> values from the user, which we can get using <code>sys.argv</code>:</p>
<pre><code class="diff">haoyi-mbp:test haoyi$ git --no-pager diff
diff --git a/trip.py b/trip.py
index 7e931bf..de4da24 100644
--- a/trip.py
+++ b/trip.py
@@ -5,7 +5,8 @@ import pprint
 start = sys.argv[1]
 end = sys.argv[2]
 current_time = int(sys.argv[3])
-
+cost_per_stop = float(sys.argv[4])
+cost_per_transfer = float(sys.argv[5])
 print "loading JSON"

 stops = json.loads(open("stops.json").read())
</code></pre>
<p>This allows us to get the <code>cost_per_stop</code> and <code>cost_per_transfer</code> from the user running the script, as floating point numbers. Intuitively, a value of e.g. <code>1.0</code> for <code>cost_per_stop</code> is saying "*consider each stop as taking additional time equivalent to driving 1km*", and similarly a value of <code>1.0</code> for <code>cost_per_transfer</code>. </p>
<p>And lastly, we need to modify our result-printing code to nicely display all data we're returning:</p>
<pre><code class="diff">-path = dijstras(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
-def find_service(i):
-    for (service, direction), route in routes_map.items():
-        for j in range(len(route)-1):
-            if path[i] == route[j]["BusStopCode"] and path[i+1] == route[j+1]["BusStopCode"]:
-                return (
-                	service, 
-                	stop_code_map[path[i]]["Description"],
-                	stop_code_map[path[i + 1]]["Description"]
-            	)
-
-for i in range(len(path) - 1):
-    print find_service(i)
-print len(path), "stops"
+(cost, distance, transfers, path) = dijkstras(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])
+
+for code, service in path:
+    print service, stop_code_map[code]["Description"]
+print len(path), "stops"
+print "cost", cost
+print "distance", distance, "km"
+print "transfers", transfers
</code></pre>
<p>Here we're getting rid of the hacky <code>find_service</code> function, since our modified <code>dijkstras</code> function now keeps track of which services it is taking out-of-the-box as path of the <code>path</code> it returns. We simply print:</p>
<ul>
  <li>All the bus stops (identified by their <code>code</code>) and <code>service</code>s in <code>path</code>,</li>
  <li>How many stops the path took</li>
  <li>What it's final <code>cost</code> is, including distance, transfers, stops</li>
  <li>How may kilometers long the route is</li>
  <li>How many transfers were taken</li>
</ul><h3 id="completeness">Completeness</h3>
<p>And now we're done! We have a bus-trip-planner that we can run from the command line, give it start/end bus stops, time-of-day, and how much to penalize stopping at bus-stops or transferring buses, and it'll give you the best bus route it can find to make that trip. If you're not sure where the last series of patches and diffs has brought us, take a look at the <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#final-code">Final Code</a></p>
<p>Although you haven't seen me run the final version of the code yet, I did in fact run it many times while debugging and figuring out why things went wrong. As for you, you can simply enjoy the interesting results that can be demonstrated by running this code, which is long enough that it deserves its own section of this post</p><h2 id="evaluation">Evaluation</h2>
<p>We've made all the changes necessary to hit our original criteria! Let's run through a few cases with this script:</p><h3 id="no-cost-for-stops-or-transfers">No Cost for Stops or Transfers</h3>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter" 1700 0 0
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Opp Orchard Stn
(u'14', 1) Opp Paterson Lodge
(u'14', 1) Bef Zion Full Gospel Ch
(u'54', 1) Opp ERC Inst
(u'195', 1) Airview Twr
(u'195', 1) Aft AA Ctr
(u'32', 2) Opp Mohd Sultan Rd
(u'32', 2) Opp Liang Ct
(u'195', 1) Opp Clarke Quay
(u'195', 1) Supreme Ct
(u'195', 1) Pan Pacific Hotel
(u'97', 1) Marina Ctr Ter
(u'36', 1) Aft Raffles Blvd
(u'36', 1) Fort Rd JUNCTION/ECP
(u'518', 1) Eastern Lagoon II
(u'518', 1) Aft Bedok Sth Ave 1
(u'518', 1) Opp Kg Chai Chee CC
(u'17', 1) Blk 521
(u'17', 1) Blk 516
(u'17A', 1) Opp Fengshan Pr Sch
(u'18', 1) Blk 506
(u'168', 1) Opp Blk 761
(u'168', 1) Opp The Clearwater Condo
(u'5', 2) Opp Bedok Reform Trg Ctr
(u'168', 1) Opp SAFRA Tampines
(u'518', 1) Blk 141
(u'518', 1) Opp The Holy Trinity Ch
(u'518', 1) Blk 206
(u'28', 2) Tampines East CC
(u'518', 1) Tampines JC
(u'12', 2) Blk 497D
(u'9', 1) Blk 149A
(u'9', 1) Blk 275
(u'59', 1) Aft Pasir Ris Dr 3
(u'19', 1) Opp Loyang Valley
(u'89', 1) Loyang Ind Est
(u'109', 1) Bef Loyang Way
(u'109', 1) Opp Engine Test Facility
(u'89', 1) LP 80
(u'109', 1) Bef Sch Of Commando
(u'109', 1) Bef Cranwell Rd
(u'2', 2) Opp Maranatha B-P Ch
(u'89', 1) Aft Changi Golf Course
(u'109', 1) Blk 5
(u'2', 2) Changi Village Ter
45 stops
cost 16.5
distance 16.5 km
transfers 29
</code></pre>
<p>Here, you can see that the algorithm picks a really short route - 16.5km - to get from <code>Opp Orchard Stn</code> to <code>Changi Village Ter</code>. However, because we input that transfers are cost <code>0</code>, it takes all sorts of unnecessary transfers between services, 29 in total! However, the behavior changes once you introduce even a tiny cost for transfering buses.</p>
<ul>
  <li><strong>Note</strong>: <code>transfers</code> counts how many distinct bus services you take; e.g.  even if you take a single bus it counts as 1 "transfer". Another way of  looking at it is your first bus counts as a trasnfer from "no service" to  "some service". This is a technical detail that doesn't affect the algorithm  or the trip-planning since every trip is equally affected, and you can easily  <code>- 1</code> from the final <code>transfer</code> count if you want to count only  transfers-between-buses.</li>
</ul><h3 id="no-cost-for-stops-low-cost-for-transfers">No Cost for Stops, Low Cost for Transfers</h3>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter" 1700 0 0.1
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Opp Orchard Stn
(u'14', 1) Opp Paterson Lodge
(u'54', 1) Bef Zion Full Gospel Ch
(u'54', 1) Opp ERC Inst
(u'195', 1) Airview Twr
(u'195', 1) Aft AA Ctr
(u'195', 1) Opp Mohd Sultan Rd
(u'195', 1) Opp Liang Ct
(u'195', 1) Opp Clarke Quay
(u'195', 1) Supreme Ct
(u'195', 1) Pan Pacific Hotel
(u'97', 1) Marina Ctr Ter
(u'36', 1) Aft Raffles Blvd
(u'36', 1) Fort Rd JUNCTION/ECP
(u'518', 1) Eastern Lagoon II
(u'518', 1) Aft Bedok Sth Ave 1
(u'518', 1) Opp Kg Chai Chee CC
(u'17', 1) Blk 521
(u'17', 1) Blk 516
(u'17', 1) Opp Fengshan Pr Sch
(u'18', 1) Blk 506
(u'18', 1) Opp Blk 761
(u'18', 1) Opp The Clearwater Condo
(u'18', 1) Opp Bedok Reform Trg Ctr
(u'18', 1) Opp SAFRA Tampines
(u'18', 1) Blk 141
(u'18', 1) Opp The Holy Trinity Ch
(u'18', 1) Blk 206
(u'59', 1) Tampines East CC
(u'59', 1) Tampines JC
(u'59', 1) Blk 497D
(u'59', 1) Blk 149A
(u'59', 1) Blk 275
(u'59', 1) Aft Pasir Ris Dr 3
(u'59', 1) Opp Loyang Valley
(u'59', 1) Loyang Ind Est
(u'59', 1) Bef Loyang Way
(u'59', 1) Opp Engine Test Facility
(u'59', 1) LP 80
(u'59', 1) Bef Sch Of Commando
(u'59', 1) Bef Cranwell Rd
(u'59', 1) Opp Maranatha B-P Ch
(u'59', 1) Aft Changi Golf Course
(u'59', 1) Blk 5
(u'59', 1) Changi Village Ter
45 stops
cost 17.4
distance 16.5 km
transfers 9
</code></pre>
<p>Here, we told the algorithm to count a transfer as an additional 0.1 kilometers traveled. Already that's enough to make it find a path with 9 transfers instead of 29. Note that the actual distance travelled hasn't changed at all: it's telling us to go through the exact same stops, just being smarter about staying on the same bus where possible </p>
<p>Realistically though, a bus transfer costs much more than 0.1km of travel: you can easily wait ~15 minutes for a bus when transferring! </p><h3 id="no-cost-for-stops-moderate-cost-for-transfers">No Cost for Stops, Moderate cost for transfers</h3>
<p>Assuming a bus averages 20km/h, and a transfer has you waiting 15 minutes, we can count a transfer as equivalent to 5km traveled:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter" 1700 0 5
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Opp Orchard Stn
(u'36', 1) Opp Four Seasons Hotel
(u'36', 1) The Regent S`pore
(u'36', 1) Aft Tomlinson Rd
(u'36', 1) Delfi Orchard
(u'36', 1) Royal Thai Embassy
(u'36', 1) Tang Plaza
(u'36', 1) Opp Mandarin Orchard
(u'36', 1) Concorde Hotel S`pore
(u'36', 1) Dhoby Ghaut Stn
(u'36', 1) Rendezvous Grand Hotel
(u'36', 1) NTUC Income Ctr
(u'36', 1) Raffles Hotel
(u'36', 1) Suntec Convention Ctr
(u'36', 1) Opp Millenia Twr
(u'36', 1) Marina Ctr Ter
(u'36', 1) Aft Raffles Blvd
(u'36', 1) Fort Rd JUNCTION/ECP
(u'518', 1) Eastern Lagoon II
(u'518', 1) Aft Bedok Sth Ave 1
(u'518', 1) Opp Kg Chai Chee CC
(u'17', 1) Blk 521
(u'17', 1) Blk 516
(u'17', 1) Opp Fengshan Pr Sch
(u'17', 1) Blk 109
(u'17', 1) Blk 99
(u'17', 1) St. Anthony`s Cano Sch
(u'17', 1) Opp Goldbell Svc Ctr
(u'17', 1) SBST Bedok Bus Pk
(u'17', 1) Blk 3011
(u'17', 1) Blk 3012
(u'17', 1) Opp Changi General Hosp
(u'17', 1) Blk 141
(u'17', 1) Opp The Holy Trinity Ch
(u'17', 1) Blk 206
(u'17', 1) Tampines East CC
(u'17', 1) Tampines JC
(u'59', 1) Blk 497D
(u'59', 1) Blk 149A
(u'59', 1) Blk 275
(u'59', 1) Aft Pasir Ris Dr 3
(u'59', 1) Opp Loyang Valley
(u'59', 1) Loyang Ind Est
(u'59', 1) Bef Loyang Way
(u'59', 1) Opp Engine Test Facility
(u'59', 1) LP 80
(u'59', 1) Bef Sch Of Commando
(u'59', 1) Bef Cranwell Rd
(u'59', 1) Opp Maranatha B-P Ch
(u'59', 1) Aft Changi Golf Course
(u'59', 1) Blk 5
(u'59', 1) Changi Village Ter
52 stops
cost 39.3
distance 19.3 km
transfers 4
</code></pre>
<p>Here, you can see the actual distance-on-road traveled has risen from 16.5km to 19.3km: given the fact that transfers "cost 5km each", the trip planner is actively picking a longer journey to minimize the number of transfers. It's brought us down to 4 transfers.</p>
<p>If we wanted to, we could tell the trip planner to consider transfers "all important", and to avoid them at all costs. That will make it produce a route that minimizes the number of transfers at the expense of all else.</p><h3 id="no-cost-for-stops-maximum-cost-for-transfers">No Cost for Stops, Maximum Cost for Transfers</h3>
<p>Here, we tell the trip planner that a transfer costs the same as driving 9999 kilometers. That's obviously an absurd number, and just needs to be high enough to make it outweigh all other considerations:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter" 1700 0 9999
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Opp Orchard Stn
(u'36', 1) Opp Four Seasons Hotel
(u'36', 1) The Regent S`pore
(u'36', 1) Aft Tomlinson Rd
(u'36', 1) Delfi Orchard
(u'36', 1) Royal Thai Embassy
(u'36', 1) Tang Plaza
(u'36', 1) Opp Mandarin Orchard
(u'36', 1) Concorde Hotel S`pore
(u'65', 2) Macdonald Hse
(u'65', 2) Sch of the Arts
(u'65', 2) Peace Ctr
(u'65', 2) Selegie Ctr
(u'65', 2) Tekka Ctr
(u'65', 2) Broadway Hotel
(u'65', 2) Sri Srinivasa Perumal Tp
(u'65', 2) Sri Vadapathira K Tp
(u'65', 2) Kwong Wai Shiu Hosp
(u'65', 2) Boon Keng Stn
(u'65', 2) Opp Bendemeer Pr Sch
(u'65', 2) St. Michael`s Pl
(u'65', 2) Aft Tai Thong Cres
(u'65', 2) Opp Gulab Bldg
(u'65', 2) Opp Cencon Bldg
(u'65', 2) Aljunied Pk
(u'65', 2) Aft Jln Anggerek
(u'65', 2) Blk 14
(u'65', 2) Blk 77
(u'65', 2) Blk 36
(u'65', 2) MacPherson Sec Sch
(u'65', 2) Blk 3019
(u'65', 2) Blk 3021
(u'65', 2) Blk 3023
(u'65', 2) Automobile Megamart
(u'65', 2) Blk 637
(u'65', 2) Blk 646
(u'65', 2) Blk 122
(u'65', 2) Blk 133
(u'65', 2) Blk 140
(u'65', 2) Aft Kaki Bt Ctr
(u'65', 2) Opp Blk 701
(u'65', 2) Blk 745
(u'65', 2) Opp Blk 716
(u'65', 2) Opp Waterfront Isle
(u'59', 1) Opp Waterfront Waves
(u'59', 1) Opp Waterfront Key
(u'59', 1) Opp The Clearwater Condo
(u'59', 1) Opp Bedok Reform Trg Ctr
(u'59', 1) Opp SAFRA Tampines
(u'59', 1) Blk 141
(u'59', 1) Opp The Holy Trinity Ch
(u'59', 1) Blk 206
(u'59', 1) Tampines East CC
(u'59', 1) Tampines JC
(u'59', 1) Blk 497D
(u'59', 1) Blk 149A
(u'59', 1) Blk 275
(u'59', 1) Aft Pasir Ris Dr 3
(u'59', 1) Opp Loyang Valley
(u'59', 1) Loyang Ind Est
(u'59', 1) Bef Loyang Way
(u'59', 1) Opp Engine Test Facility
(u'59', 1) LP 80
(u'59', 1) Bef Sch Of Commando
(u'59', 1) Bef Cranwell Rd
(u'59', 1) Opp Maranatha B-P Ch
(u'59', 1) Aft Changi Golf Course
(u'59', 1) Blk 5
(u'59', 1) Changi Village Ter
69 stops
cost 30023.9
distance 26.9 km
transfers 3
</code></pre>
<p>As you can see, it's managed to bring the number of transfers down from 4 to 3, albeit at a cost of increasing the distance traveled from 19.3km to 26.9km. Further increases to the cost of transfers does nothing: this is already the minimum number of transfers possible!</p><h3 id="maximum-cost-for-stops-low-cost-for-transfers">Maximum Cost for Stops, Low Cost for Transfers</h3>
<p>Apart from transfers, the other thing we can tell our trip planner to weigh is the number of bus stops crossed. Buses take time to pull into each stop, and load/unload passengers. What if wanted it to at-all-costs minimize the number of bus stops traveled? In that case we can give an absurd cost of <code>9999</code> for each bus stop, and leave a low cost of <code>0.1</code> per transfer just to keep it from needlessly switching buses:</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp Orchard Stn" "Changi Village Ter" 1700 9999 0.1
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Opp Orchard Stn
(u'36', 1) Opp Four Seasons Hotel
(u'36', 1) The Regent S`pore
(u'36', 1) Aft Tomlinson Rd
(u'132', 2) Delfi Orchard
(u'132', 2) Royal Thai Embassy
(u'132', 2) Thong Teck Bldg
(u'190', 2) Raffles Girls` Sch
(u'190', 2) Chelsea Gdn Condo
(u'190', 2) Opp Met YMCA
(u'190', 2) Opp Stevens Ct
(u'190', 2) Raffles Town Club
(u'190', 2) Express
(u'858', 1) Express
(u'858', 1) Airport Police Stn
(u'53', 1) Bef Changi Airport PTB3
(u'53', 1) Changi Airport PTB3
(u'53', 1) Changi Airport PTB1
(u'53', 1) Changi Airport PTB2
(u'53', 1) Aft Changi Airport PTB2
(u'53', 1) Near SATS Flight Kitchen
(u'53', 1) At Track 33 Int
(u'53', 1) Blk 149A
(u'59', 1) Blk 275
(u'59', 1) Aft Pasir Ris Dr 3
(u'59', 1) Opp Loyang Valley
(u'59', 1) Loyang Ind Est
(u'59', 1) Bef Loyang Way
(u'59', 1) Opp Engine Test Facility
(u'59', 1) LP 80
(u'59', 1) Bef Sch Of Commando
(u'59', 1) Bef Cranwell Rd
(u'59', 1) Opp Maranatha B-P Ch
(u'59', 1) Aft Changi Golf Course
(u'59', 1) Blk 5
(u'59', 1) Changi Village Ter
36 stops
cost 350047.7
distance 82.1 km
transfers 6
</code></pre>
<p>Here, you can see that the trip planner has found a route that has 36 bus stops instead of 45, but in the process increases the length of the route from 16.5km to 82.1km! Obviously this is not a route that you would want to do in real life, but it is an interesting demonstration that depending on what you tell the trip planner to focus on, you could get very different results. If you tell it that the number of bus stops is the most important thing, much more than anything else (<code>cost_per_stop = 9999</code>) then we can't be surprised if it finds a route optimizing for the number of stops, sacrificing the distance-traveled in the process!</p><h3 id="other-trips">Other Trips</h3>
<p>To properly evaluate the trip-planner, let's throw it a few more trips to plan, that we already know the answer to, to see how it fares! </p>
<ul>
  <li><strong>Note</strong>: For these we'll use "reasonable" costs for bus-stops and  bus-transfers: counting each bus stop as equivalent to traveling 0.5km, and  each bus transfer as traveling 5km. With an average speed of 20km/h, that's  equivalent to saying each stop is for 90s and each bus transfer takes 15  minutes; not exact, but roughly the correct order of magnitude.</li>
</ul>
<p>For example, can it find the short direct bus from <code>Grange Residences</code> to <code>Redhill Stn</code>?</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Grange Residences" "Redhill Stn" 1500 0.5 5
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Grange Residences
(u'132', 1) Opp British High Comm
(u'132', 1) Bef Rochalie Dr
(u'132', 1) Bef Chatsworth Rd
(u'132', 1) Crescent Girls` Sch
(u'132', 1) Redhill Stn
6 stops
cost 9.8
distance 2.3 km
transfers 1
</code></pre>
<p>How about the long direct bus between <code>Ghim Moh Ter</code>minal and <code>The Esplanade</code>?</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Ghim Moh Ter" "The Esplanade" 1500 0.5 5
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Ghim Moh Ter
(u'111', 1) Blk 12
(u'111', 1) Blk 43
(u'111', 1) Blk 8
(u'111', 1) C`wealth Stn
(u'111', 1) Aft Ch Of Our Saviour
(u'111', 1) Queenstown Stn
(u'111', 1) Blk 53A CP
(u'111', 1) Opp SM Motors Ctr
(u'111', 1) Opp SIS Bldg
(u'111', 1) Aft Margaret Dr
(u'111', 1) Opp Chatsworth Rd
(u'111', 1) Aft Rochalie Dr
(u'111', 1) British High Comm
(u'111', 1) Aft Tomlinson Rd
(u'111', 1) Delfi Orchard
(u'111', 1) Royal Thai Embassy
(u'111', 1) Lucky Plaza
(u'111', 1) Midpoint Orchard
(u'111', 1) Concorde Hotel S`pore
(u'111', 1) Dhoby Ghaut Stn
(u'111', 1) Rendezvous Grand Hotel
(u'111', 1) NTUC Income Ctr
(u'111', 1) Raffles Hotel
(u'111', 1) Suntec Convention Ctr
(u'111', 1) Opp Millenia Twr
(u'111', 1) Opp The Ritz-Carlton
(u'111', 1) Seating Gallery
(u'111', 1) The Esplanade
29 stops
cost 31.1
distance 12.1 km
transfers 1
</code></pre>
<p>How about the 1-transfer necessary to go from my old school ACS(I) to Orchard MRT?</p>
<pre><code class="python">haoyi-mbp:test haoyi$ python trip.py "Opp ACS Boarding Sch" "Orchard Stn" 1500 0.5 5
loading JSON
Initializing  tables
Initializing Graph
Running BFS
None Opp ACS Boarding Sch
(u'33', 2) Fairfield Meth Pr Sch
(u'33', 2) Ayer Rajah Ind Est
(u'33', 2) Opp PSB Science Pk Bldg
(u'33', 2) Opp Normanton Pk
(u'33', 2) Alexandra Hosp
(u'33', 2) Anchorpoint
(u'33', 2) Opp Lea Hin Hardware Fty
(u'33', 2) Opp SM Motors Ctr
(u'33', 2) Redhill Stn
(u'33', 2) Delta Swim Cplx
(u'33', 2) Blk 104A CP
(u'33', 2) Tiong Bahru Pk
(u'33', 2) Tiong Bahru Plaza
(u'33', 2) Blk 1
(u'33', 2) EtonHouse Pre-Sch
(u'33', 2) Outram Pk Stn
(u'33', 2) People`s Pk Cplx
(u'143', 2) Opp Subordinate Ct
(u'143', 2) Shell HSE
(u'143', 2) Aft River Valley Rd
(u'143', 2) Opp Haw Par Glass Twr
(u'143', 2) Winsland Hse
(u'143', 2) Somerset Stn
(u'143', 2) Opp Ngee Ann City
(u'143', 2) Orchard Stn
26 stops
cost 35.0
distance 12.5 km
transfers 2
</code></pre>
<p>All three routes look correct. Seems like the trip-planner works!</p><h3 id="limitations">Limitations</h3>
<p>It's worth remembering our original problem statement, and spelling out some expected/implicit limitations of the code we wrote:</p>
<ol>
  <li>
  <p>This does not handle multi-modal transport: it doesn't know how to plan  trips including trains, or even walking, meaning that even if a 5-minute  walk could save an hour of busing this trip-planner won't know about it</p></li>
  <li>
  <p>It's treatment of bus-transfers is crude; it treats all transfers as equally  costly, while in reality there is information available about how frequently  buses arrive at each stop, and even <em>exactly what times the next few buses  are expected to arrive</em> via the <code>/BusArrival</code> API. This allows you to pull  down bus arrival information for any bus service at any (or <em>every</em>!) bus  stop on the island! We could use this to make the algorithm optimize for this  waiting time, finding routes that "line up" transfers and minimizing the  time you spend waiting at a stop.</p></li>
  <li>
  <p>It's understanding of Time is simplistic: it simply filters out buses which  are unavailable when you <em>start</em> the trip, not understanding that as the  trip progresses more buses may become unavailable. It does not understand  the fact that bus frequencies, and thus the expected wait for a transfer,  changes during the morning/evening peak hours and on weekends. All this data  is available in the various APIs, we would just need to put it to use.</p></li>
  <li>
  <p>It's a command-line application. More work would be needed to turn it into  a mobile app, or a website, or a desktop widget. Nevertheless, the work  to make mobile apps, websites, or desktop widgets is pretty orthogonal to  working with these datasets or APIs, and you can learn those skills  elsewhere.</p></li>
  <li>
  <p>The app measures distance traveled, but does not take into account the  <em>speed</em> at which you're traveling along each road! That data is actually all  freely available from the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> from the <code>/TrafficSpeedBandSet</code>  endpoint, in real-time (i.e. what is the speed <em>right now</em>). While not very  precise (it seems to have only 4 buckets 0-20, 20-40, 40-60, 60+) it would  be enough for a trip-planner to use to plan routes avoiding major congestion</p></li>
</ol><h2 id="conclusion">Conclusion</h2>
<p>In this post, we've made a rudimentary bus-trip-planner from first principles: </p>
<ul>
  <li>
  <p><strong>Exploring APIs related to the <a href="http://www.pmo.gov.sg/smartnation">Singapore Smart Nation</a> initiative</strong>. We've  broadly browsed and surveyed the landscape of possibilities, and seen what  the most prominent and well-published APIs in that space are.</p></li>
  <li>
  <p><strong>Browsing, selecting and downloading data from the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> API</strong>.  We've fidgeted with API credentials, dug through weird PDF documentation on  awkward websites, and done all that's necessary to get the data we want</p></li>
  <li>
  <p><strong>Exploring it in <a href="https://ipython.org/install.html">IPython</a> to see what's there and validating some basic  assumptions</strong>. We've worked with data too large to browse manually, and seen  how you can use the <a href="https://ipython.org/install.html">IPython</a> shell to understand it quickly in-bulk, in a  matter of seconds asking questions of quantities of data far-too-large to  answer manually. We've found peculiarities, missing datapoints, and outright  <em>mistakes</em> in the dataset, and learned to deal with them and work around  them.</p></li>
  <li>
  <p><strong>Written standalone application that can be run using this data</strong>. It might  not be pretty - it's a command-line program after all! - but it works, and  is something you can package up and run on some server, on your phone, or on  your friends' laptops.</p></li>
  <li>
  <p><strong>Made use of basic algorithms to turn it into a useful, flexible, and  powerful trip-planner</strong>. While almost every programmer learns these  algorithms in school, we've used them in a concrete way on concrete datasets  in order to plan trips across Singapore.</p></li>
</ul>
<p>In the process, we've written about 150 lines of Python, the final code being <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#final-code">available below</a>. Although there's no way we can compete with <a href="https://www.google.com.sg/maps">Google Maps</a> or <a href="http://gothere.sg/maps">gothere.sg</a>, it's not a bad outcome for 150 lines of code! Hopefully this post has shown how easy it is to make "something useful" with the datasets and APIs being exposed as part of the <a href="http://www.pmo.gov.sg/smartnation">Singapore Smart Nation</a> initiative, as well as how "freshman year" algorithms and computer-science can be used to accomplish real work and make cool, useful things. </p>
<p>Let me know what you think in the comments below! </p><h2 id="final-code">Final Code</h2>
<p>Here's the final output of this whole exercise. Everything should be runnable except for installing <a href="https://www.python.org/">Python</a>/<a href="http://docs.python-requests.org/en/master/">Requests</a>/<a href="https://ipython.org/install.html">IPython</a> and needing to swap in your own <code>AccountKey</code> and <code>UniqueUserId</code> before running.</p><h3 id="runpy">run.py</h3>
<p>This script makes it easy for you to download various data sets from the <a href="http://www.mytransport.sg/content/mytransport/home/dataMall.html">LTA Data Mall</a> and saves them to JSON files. You can also import it from the <a href="https://ipython.org/install.html">IPython</a> shell and download stuff interactively. </p>
<p>As written, it downloads information on bus stops, bus services, and bus routes, and dumps them all into JSON files for you to use later. It takes a minute or two to run, depending on how fast your internet connection is. If you want to see it making progress, put a <code>print len(results)</code> inside the <code>while</code> loop and you'll be able to see how many items it's fetched as it happens.</p>
<pre><code class="python">import requests
import json
headers = {
    'AccountKey': 'rmgDEFTiRRfcNeD8GbHqf8==',
    'UniqueUserID': '8ecabd56-08a2-e843-0a7a-9944dccf124a',
    'accept': 'application/json'
}

def fetch_all(url):
    results = []
    while True:
        new_results = requests.get(
            url,
            headers=headers,
            params={'$skip': len(results)}
        ).json()['value']
        if new_results == []:
            break
        else:
            results += new_results
    return results

if __name__ == "__main__":
    stops = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusStops")
    with open("stops.json", "w") as f:
        f.write(json.dumps(stops))
    
    services = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusServices")
    
    with open("services.json", "w") as f:
        f.write(json.dumps(services))

    routes = fetch_all("http://datamall2.mytransport.sg/ltaodataservice/BusRoutes")
    
    with open("routes.json", "w") as f:
        f.write(json.dumps(routes))
</code></pre><h3 id="trippy">trip.py</h3>
<p>This file lets you ask for a route between two named bus stops, optimized for some parameters. Called via</p>
<pre><code class="python">python trip.py "&lt;first-stop&gt;" "&lt;last-stop&gt;" &lt;time&gt; &lt;cost-per-stop&gt; &lt;cost-per-transfer&gt;
python trip.py "Opp Orchard Stn" "Changi Village Ter" 1700 0.5 5.0
</code></pre>
<p>You can run this code can be run against the data downloaded by <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#runpy">run.py</a>, or you can skip that step, directly download the <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#datasets">Datasets</a> I prepared earlier and use those.</p>
<p>Internally, it loads three JSON files that we downloaded earlier in <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#runpy">run.py</a> as part of our <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#datasets">Datasets</a>, pre-processes them a bit into more convenient data structures (<code>stop_desc_map</code>, <code>stop_code_map</code>, <code>routes_map</code> and <code>graph</code>) and then feeds the <code>graph</code>, along with user-input on how expensive it is to traversing a bus stop or make a transfer, into <a href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra's Algorithm</a> to find the "least costly" route given those criteria. At the end, it prints out that route (what stops/services it took) along with some aggregate data (distance, number-of-transfers) about the entire route.</p>
<pre><code class="python">import sys
import json
import pprint

start = sys.argv[1]
end = sys.argv[2]
current_time = int(sys.argv[3])
cost_per_stop = float(sys.argv[4])
cost_per_transfer = float(sys.argv[5])
print "loading JSON"

stops = json.loads(open("stops.json").read())
services = json.loads(open("services.json").read())
routes = json.loads(open("routes.json").read())

print "Initializing  tables"
stop_desc_map = {stop["Description"]: stop for stop in stops}
stop_code_map = {stop["BusStopCode"]: stop for stop in stops}

routes_map = {}

for route in routes:
    try:
        first_bus = int(route["WD_FirstBus"])
        last_bus = int(route["WD_LastBus"])
    except:
        continue
    if first_bus &lt;= last_bus:
        if not (first_bus &lt;= current_time &lt;= last_bus):
            continue
    if first_bus &gt; last_bus:
        if (last_bus &lt;= current_time &lt;= first_bus):
            continue

    key = (route["ServiceNo"], route["Direction"])
    if key not in routes_map:
        routes_map[key] = []
    # hack around broken data
    if (route["StopSequence"] == 4
            and route["Distance"] == 9.1
            and key == ("34", 1)):
        route["StopSequence"] = 14
    routes_map[key] += [route]

print "Initializing Graph"
graph = {}
for service, path in routes_map.items():
    # hack around broken data
    path.sort(key = lambda r: r["StopSequence"])
    for route_index in range(len(path) - 1):
        key = path[route_index]["BusStopCode"]
        if key not in graph:
            graph[key] = {}
        curr_route_stop = path[route_index]
        next_route_stop = path[route_index + 1]
        curr_distance = curr_route_stop["Distance"] or 0
        next_distance = next_route_stop["Distance"] or curr_distance
        distance = next_distance - curr_distance
        assert distance &gt;= 0, (curr_route_stop, next_route_stop)
        curr_code = curr_route_stop["BusStopCode"]
        next_code = next_route_stop["BusStopCode"]
        graph[curr_code][(next_code, service)] = distance

print "Running BFS"

def dijkstras(graph, start, end):
    import heapq
    seen = set()
    # maintain a queue of paths
    queue = []
    # push the first path into the queue
    heapq.heappush(queue, (0, 0, 0, [(start, None)]))
    while queue:
        # get the first path from the queue
        (curr_cost, curr_distance, curr_transfers, path) = heapq.heappop(queue)

        # get the last node from the path
        (node, curr_service) = path[-1]

        # path found
        if node == end:
            return (curr_cost, curr_distance, curr_transfers, path)

        if (node, curr_service) in seen:
            continue

        seen.add((node, curr_service))
        # enumerate all adjacent nodes, construct a new path and push it into the queue
        for (adjacent, service), distance in graph.get(node, {}).items():
            new_path = list(path)
            new_path.append((adjacent, service))
            new_distance = curr_distance + distance
            new_cost = distance + curr_cost
            new_transfers = curr_transfers
            if curr_service != service:
                new_cost += cost_per_transfer
                new_transfers += 1
            new_cost += cost_per_stop

            heapq.heappush(queue, (new_cost, new_distance, new_transfers, new_path))

(cost, distance, transfers, path) = dijkstras(graph, stop_desc_map[start]["BusStopCode"], stop_desc_map[end]["BusStopCode"])

for code, service in path:
    print service, stop_code_map[code]["Description"]
print len(path), "stops"
print "cost", cost
print "distance", distance, "km"
print "transfers", transfers
</code></pre><h3 id="datasets">Datasets</h3>
<p>Here are the JSON data-sets that I downloaded to use offline as part of <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#caching">Caching</a>. No doubt these files will get stale over time, possible next week, probably next month, definitely in the next year. Nevertheless, there's value in keeping </p>
<p>While you can always re-download them using <a href="http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html#runpy">run.py</a>, doing so is slow, and if the API changes or gets shut down, these files will remain here so people can still follow along. </p>
<ul>
  <li><a href="http://www.lihaoyi.com/post/SmartNation/routes.json">routes.json</a></li>
  <li><a href="http://www.lihaoyi.com/post/SmartNation/stops.json">stops.json</a></li>
  <li><a href="http://www.lihaoyi.com/post/SmartNation/services.json">services.json</a></li>
</ul><div><hr><div style="color: rgb(158, 167, 174);">Updated <a href="https://github.com/lihaoyi/blog/commit/97f357c43b1c6fa49fed7272689c99ac3b73fb8f">2016-03-31 </a><a href="https://github.com/lihaoyi/blog/commit/98e4390da0e6d49c689218ae357b324bd4fd423e">2016-03-31 </a><a href="https://github.com/lihaoyi/blog/commit/6e0b8a76e3fb4f4219677e11cbb76714348d6dd9">2016-03-31 </a><a href="https://github.com/lihaoyi/blog/commit/b65c0a6d18517a8441e58582199ad0fd48e4aa90">2016-03-31 </a><a href="https://github.com/lihaoyi/blog/commit/b3d902a814db224b4a2b7da11709997b9b5ffbdf">2016-03-31 </a><a href="https://github.com/lihaoyi/blog/commit/c334d09231e13c359477795309c92cfa5e4bb015">2016-03-31 </a><a href="https://github.com/lihaoyi/blog/commit/434879af2bcb182271af2d6d646dd17fa214e5c8">2016-03-31 </a><a href="https://github.com/lihaoyi/blog/commit/2a28cf335e98305b8c6b71adddda57e1aad80e85">2016-03-31 </a></div></div><div id="disqus_thread"><iframe id="dsq-app1" name="dsq-app1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 751px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div><script>
      /**
      * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
      * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
      */

      var disqus_config = function () {
      this.page.url = "http://www.lihaoyi.com/post/PlanningBusTripswithPythonSingaporesSmartNationAPIs.html"; // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "Planning Bus Trips with Python & Singapore's Smart Nation APIs"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');

      s.src = '//lihaoyi.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
      })();
  </script></div><div class=" WideStyles-footer Styles-footer">Last published 2016-12-09</div><iframe style="display: none;" src="./Planning Bus Trips with Python &amp; Singapore&#39;s Smart Nation APIs_files/saved_resource(1).html"></iframe></body></html>